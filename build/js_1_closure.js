(function(){var K;function D(a,b){for(let d=0;d<a;d+=1)b(d,a)}function P(a,b){return{x:b*Math.cos(a),y:b*Math.sin(a)}}function ta(a,b){return a.rotate(L/180*b.rx,L/180*b.ry,L/180*b.rz)}function ua(a){const {facing:b}=a;return ta(new t(b,void 0,void 0),a)}function Ga(a,b){let {rx:d,ry:e,rz:h}=a;d+=b.rx;e+=b.ry;h+=b.rz;return{rx:d,ry:e,rz:h}}function ea(a,b=0,d=1){return a<b?b:a>d?d:a}function va(a,b,d){return b+ea(a)*(d-b)}function X(a=1,b=0){return b+Math.random()*(a-b)}function wa(a,b){const d=Q.getElementById(a),
e=d||Q.createElement("canvas");e.id=a;e.width=e.height=b;d||Q.getElementById("loaded").appendChild(e);return[e,e.getContext("2d"),b/2]}function Ha(a,b){const [d,e]=wa(a,800);D(1400,()=>{e.rect(b.int(0,800),b.int(0,800),1,1)});e.fillStyle="#ebd694";e.fill();return d}function Y(a=4,b="#f00",d,e=.4,h=600){const [k,m,l]=wa(d,h);m.clearRect(0,0,h,h);m.beginPath();const f=Ia/a;D(a,n=>{const {x:q,y:z}=P(f*n,l);m.lineTo(l+q,l+z);const {x:u,y:A}=P(f*n+f/2,l*e);m.lineTo(l+u,l+A)});m.fillStyle=b;m.fill();return k}
function Ja(a){const b=`k${a}`;var d={x:E(2E3),y:E(2E3),z:E(2E3)};a={n:b,...structuredClone(Ka),...d,size:5,r:10};p.group({n:b,g:"system",...d});const e={g:b,size:2.5,x:-1.5,b:"372b4e"};d={g:b,size:2,b:"471b6e"};p.cube({...e,n:b+"c",rx:45,b:"471b6e"});D(4,h=>{p.cube({...e,n:`${b}cc${h}`,x:-2-h,size:2.5-.5*h})});p.pyramid({n:b+"nose",rz:-90,g:b,size:1.5,b:"90d59c"});p.longRect({...d,n:b+"wing1",y:2,rx:90,ry:45,rz:-45});p.longRect({...d,n:b+"wing2",y:2,x:1.5,rx:90,ry:45,rz:45,b:"471b6e"});p.longRect({...d,
n:b+"wing3",y:-2,rx:90,ry:45,rz:45});p.longRect({...d,n:b+"wing4",y:-2,x:1.5,rx:90,ry:45,rz:-45,b:"471b6e"});p.sphere({n:b+"shield",g:b,size:10,b:"ebd69404"});fa.push(a);ha[a.n]=a;xa.push(a)}function La(a,b){p=a;p.group({n:"system"});["sun","ring","p1","p2","p3"].forEach(e=>p.group({n:e,g:"system"}));["ship","skybox"].forEach(e=>p.group({n:e}));a=Y(16,"#de8b6f88","sun",.7);p.sphere({n:"outerSun",g:"sun",size:500,b:"#de8b6f88"});p.sphere({n:"innerSun",g:"sun",size:480,b:"#de8b6f"});p.billboard({n:"sunFlare",
g:"sun",size:640,b:"#de8b6f",t:a});p.sphere({n:"planet1",g:"p1",...P(.5,3E3),size:200,b:"775b5b",s:1});p.sphere({n:"planet2",g:"p2",...P(.7,4E3),size:120,b:"#b0455a",s:1});p.sphere({n:"planet3",g:"p3",...P(.7,7E3),size:80,b:"775b5b",s:1});a=Ha("sf",ya);[{z:-b,b:"0000",t:a},{y:-b,rx:-90,b:"0000",t:a},{y:b,rx:90,b:"0000",t:a},{x:-b,ry:90,b:"0000",t:a},{x:b,ry:-90,b:"0000",t:a},{z:b,rx:180,b:"0000",t:a}].forEach((e,h)=>{p.plane({b:"000",...e,n:`skybox${h}`,g:"skybox",size:2*b})});p.longPyramid({n:"shipBase",
g:"ship",size:.18,y:.18,b:"5796a1"});p.ufo({n:"shipBody",g:"ship",y:-.06,rx:90,size:.39,b:"5796a1",s:1});p.ufo({n:"sCockpit",g:"ship",y:-.06,rx:90,z:.12,size:.15,b:"666c",s:1});a={n:"shipComp1",g:"ship",x:-.09,y:-.21,size:.12,b:"5796a1"};p.cube(a);p.cube({...a,n:"shipComp2",x:-a.x});a={n:"shipEngine1",g:"ship",ry:45,rx:90,x:.33,y:-.09,size:.3,b:"8bc7bf"};p.longerRect(a);p.longerRect({...a,n:"shipEngine2",x:-.33});a={n:"shipEngineBack1",g:"ship",x:.33,y:-.3,size:.3/3,b:"5796a1"};p.longPyramid(a);p.longPyramid({...a,
n:"shipEngineBack2",x:-.33});p.plank({n:"sWing1",g:"ship",rx:90,ry:90,x:-0,y:-.09,z:0,size:.03,b:"5796a1"});a={g:"ship",n:"sFlame1",rx:180,x:.33,y:-.42,size:.078,b:"ebd69400"};p.longPyramid(a);p.longPyramid({...a,n:"sFlame2",x:-.33});D(6,Ja);const d=2*Math.PI;D(32,(e,h)=>{var k=0===e?0:d*e/h;h=180/L*k;let {x:m,y:l}=P(k,2E3);k=`r${e}`;p.group({n:k,g:"ring"});p.plank({n:`ring${e}`,g:k,x:m,y:l,rz:h,size:20,b:"5796a1"});p.cube({n:`ringBuilding${e}`,g:k,x:m,y:l,rz:h,size:50,b:"478691"})});D(300,e=>{p.billboard({n:`litter${e}`,
g:"system",x:E(4E3),y:E(4E3),z:E(4E3),size:1,b:"555e"})});D(30,e=>{e={n:`crate${e}`,passType:"crate",passthru:["crate"],g:"system",x:E(3E3),y:E(3E3),z:E(3E3),vel:{...(new t(void 0,void 0,void 0))},size:3,r:2,b:"de8b6f",rx:X(0,359),ry:X(0,359),rz:X(0,359),hp:3};fa.push(e);ha[e.n]=e;p.cube(e)});return{ship:ia,renderables:ha,physicsEnts:fa,klaxShips:xa}}function da(a,{x:b=.5,y:d=.5,z:e=.5}={}){c.add(a,{vertices:[b,d,e,-b,d,e,-b,-d,e,b,d,e,-b,-d,e,b,-d,e,b,d,-e,b,d,e,b,-d,e,b,d,-e,b,-d,e,b,-d,-e,b,d,
-e,-b,d,-e,-b,d,e,b,d,-e,-b,d,e,b,d,e,-b,d,e,-b,d,-e,-b,-d,-e,-b,d,e,-b,-d,-e,-b,-d,e,-b,d,-e,b,d,-e,b,-d,-e,-b,d,-e,b,-d,-e,-b,-d,-e,b,-d,e,-b,-d,e,-b,-d,-e,b,-d,e,-b,-d,-e,b,-d,-e],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]})}function za(a,{x:b=.5,y:d=.5,z:e=.5}={}){c.add(a,{vertices:[-b,-d,e,b,-d,e,0,d,0,b,-d,e,b,-d,-e,0,d,0,b,-d,-e,-b,-d,-e,0,d,0,-b,-d,-e,-b,-d,e,0,d,0,b,-d,e,-b,-d,e,-b,-d,
-e,b,-d,e,-b,-d,-e,b,-d,-e],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]})}function Aa(a,{x:b=2,y:d=2,z:e=2,precision:h=20,i:k,ai:m,j:l,aj:f,p1:n,p2:q,vertices:z=[],indices:u=[],uv:A=[]}={}){const {PI:B,sin:v,cos:w}=Math;for(l=0;l<=h;l++)for(f=l*B/h,k=0;k<=h;k++)m=2*k*B/h,z.push(+(v(m)*v(f)/b).toFixed(6),+(w(f)/d).toFixed(6),+(w(m)*v(f)/e).toFixed(6)),A.push(3.5*v(k/h),-v(l/h)),k<h&&l<h&&u.push(n=l*(h+1)+k,q=n+(h+1),n+1,n+1,q,q+1);c.add(a,{vertices:z,uv:A,indices:u})}
function ja(...a){return Ma.play(...a)}function ka(a){la[a].done||(la[a].done=1,ma())}function ma(){var a=Z.klaxShips.reduce((b,d)=>b+(0<d.hp?0:1),0);a=la.map(({t:b,done:d})=>`<li class="${d?"done":""}">${b}</li>`).join("")+`<li>Klaxonian Ships Destroyed: ${a} / ${Z.klaxShips.length}</li>`+"<li>Ring Repair Parts: 0 / 5</li>";Q.getElementById("goals").innerHTML=a}function Na(a){const b=a.clientWidth,d=a.clientHeight;b>d?(x.aspect=b/d,a.height=na(b,800),a.width=b/x.aspect):(a.width=a.height=na(b,800),
x.aspect=1)}function Oa(){const a=Q.getElementById("canvas");Na(a);M.setup({lockElt:a,keys:{Tab:()=>{ka(0);M.toggleLock()}}});oa={tf:Y(9,"#ebd694","tf",.3),plasma:Y(11,"#de8b6f","plasma",.2),photon:Y(13,"#b0455a","photon",.5),klaxPlasma:Y(15,"#90d59c","klaxPlasma",.3)};a.addEventListener("click",()=>{M.lock()});c.reset(a);c.clearColor("2a242b");c.light({x:-1,y:-1.2,z:.2});c.ambient(.8);da("plank",{y:10,z:5,x:.3});da("longRect",{x:.2,y:.2});da("longerRect",{x:.2,y:.2,z:.7});da("cube");za("pyramid");
za("longPyramid",{y:.8});Aa("sphere");Aa("ufo",{y:3,precision:10});Z=La(c,12500);["renderables","ship","physicsEnts","klaxShips"].forEach(b=>{window[b]=Z[b];g[b]=Z[b]});ma()}function Ba(a,b=0){const {x:d,y:e,z:h}=ua(a).scale(b);a.thrust={x:d,y:e,z:h}}function Pa(a,b){["x","y","z"].forEach(d=>{let e=a.thrust?a.thrust[d]||0:0;0===e&&0!==a.friction&&(e=-a.vel[d]*Qa);a.vel[d]=ea(a.vel[d]+e/(a.mass||1)/b,-3E3,3E3);1E-4>a.vel[d]&&-1E-4<a.vel[d]&&(a.vel[d]=0);a[d]=ea(a[d]+a.vel[d]*b,-12500,12500)})}function Ca(a,
b){if(a.damage&&b.hp){const d=b===ship;b.hp-=a.damage;0>=b.hp&&(b.decay=0,d||ma());ja(...[d?1.1:.5,,416,.02,.21,.52,4,2.14,.2,,,,,1.7,,.9,,.44,.12,.23]);d&&flashBorder("canvas")}a.aggro+=1;b.aggro+=1;a.shieldOpacity+=5;b.shieldOpacity+=5}function Ra(a,b,d){a.collided=b;b.collided=a;Ca(a,b);Ca(b,a);d=(new t(b,void 0,void 0)).sub(a).normalize().scale((a.r+b.r-d)/2);(new t(a,void 0,void 0)).sub(d).copyTo(a);(new t(b,void 0,void 0)).add(d).copyTo(b);["x","y","z"].forEach(e=>{const h=a.mass||1,k=b.mass||
1,m=h+k,l=a.vel[e],f=b.vel[e];a.vel[e]=(h-k)/m*l+2*k/m*f;b.vel[e]=2*h/m*l+(k-h)/m*f})}function Sa(a){D(a.length,b=>{Ta(a[b],a)})}function Ta(a,b){a.collided||D(b.length,d=>{d=b[d];if(!(a.passthru&&a.passthru.includes(d.passType)||d.passthru&&d.passthru.includes(a.passType)||a===d||d.collided)){var e=(new t(a,void 0,void 0)).distance(d);e<=a.r+d.r&&Ra(a,d,e)}})}function Ua(a={}){Object.keys(a).forEach(b=>{c.move({n:b,...a[b]},0)})}function Da(a,b,d=.01){["rx","ry","rz"].forEach(e=>a[e]=va(d,a[e],b[e]))}
function Ea(a,b,d,e){const {vScale:h,tScale:k,damage:m,size:l,sound:f}=Va[a],n=oa[a],{x:q,y:z,z:u}=b,A=ua(b);b=A.scale(h).add(b.vel);ja(...f);a={n:a+d+String(Number(new Date)),g:"system",passType:d,x:q,y:z,z:u,vel:{...b},thrust:{...A.scale(k)},friction:0,decay:5,damage:m,r:5,passthru:e,mass:.01};physicsEnts.push(a);renderables[a.n]=a;c.billboard({...a,size:l,t:n})}function Wa(){var a=new t(ship.vel,void 0,void 0);const b=a.x>a.y&&a.x>a.z?"X":a.y>a.x&&a.y>a.z?"Y":"Z";a="<b>"+[`Velocity: ${pa(a.length())} (${b})`,
`Pitch: ${pa(F.rx+90)}, Yaw: ${pa(F.ry)%360}`,`Hull: ${ship.hp}`].join("</b><b>")+"</b>";Q.getElementById("si").innerHTML=a}function Xa(){const a=aa/1E3;var {down:b}=M;b["]"]&&(x.targetFov+=.5);b["["]&&(x.targetFov-=.5);if(!b.p){var d=b.Shift?2:1,e=0;if(b.s||b.S)e=ship.thrustForce*d*-.5,b.w=!1,b.W=!1;else if(b.w||b.W)e=ship.thrustForce*d;Ba(ship,e);var h=0<e?"ebd694dd":"ebd69400";c.move({n:"sFlame1",b:h});c.move({n:"sFlame2",b:h});0===e?(c.delete("sIgnite1"),c.delete("sIgnite2")):(ja(...[1<d?.15:
.1,,794,.02,.3,.32,,3.96,,.7,,,.16,2.1,,1<d?.2:.8,.1,.31,.27]),ka(1),h={g:"ship",y:-.393,rx:70,size:.2,t:oa.tf},c.billboard({...h,n:"sIgnite1",x:-.33}),c.billboard({...h,n:"sIgnite2",x:.33}));h=M.getClick();0===ship.fireCooldown&&(b[" "]||h&&h.locked)&&(ka(2),Ea(h&&h.right?"photon":"plasma",ship,"plasma",["ship","plasma"]),ship.fireCooldown=.3);ship.fireCooldown=R(ship.fireCooldown-a,0);klaxShips.forEach(f=>{if(!(0>=f.decay||0>=f.hp)){var n=new t(f,void 0,void 0),q=n.distance(ship);q>2*f.sight?f.aggro=
R(0,f.aggro-=.1):q<=f.sight&&(f.aggro=R(1,f.aggro));f.aggro&&(n=n.toWAngles(ship),Da(f,n,.02),f.thrustCooldown?f.thrustCooldown=R(f.thrustCooldown-a,0):(Ba(f,f.thrustForce),f.thrustCooldown=X(.5,3)),f.fireCooldown?f.fireCooldown=R(f.fireCooldown-a,0):(Ea("klaxPlasma",f,"klaxPlasma",["klaxShip","klaxPlasma"]),f.fireCooldown=X(.3,3)))}});Sa(physicsEnts);physicsEnts.forEach(f=>{f.collided=0;Pa(f,a)});b=M.getLockMove();F.ry-=b.x/10;F.rx=na(R(F.rx-b.y/10,-180),0);Da(ship,F,.05);b=ta(new t(0,qa.back,qa.up),
F);x.fov=va(.1,x.fov,x.targetFov+(e?0>e?-2:1<d?10:1:0));d=.001<Ya(x.fov-x.lastFov);x.lastFov=x.fov;e={...b,...Ga(qa,F),a:100};d&&(e={...e,...x});c.camera(e);var {rx:k,ry:m,rz:l}=ship;c.move({n:"ship",rx:k,ry:m,rz:l});Object.keys(renderables).forEach(f=>{const n=renderables[f];"number"===typeof n.decay&&(n.decay-=a,0>=n.decay&&(c.delete(n.n),delete renderables[f],f=physicsEnts.findIndex(q=>q.n===n.n),-1!==f&&physicsEnts.splice(f,1)))});K+=aa/90;ra+=aa/100;Ua({...renderables,system:{x:-ship.x,y:-ship.y,
z:-ship.z,a:aa},innerSun:{rx:K,ry:ra},p1:{rz:.1*K},p2:{rz:.15*K},p3:{rz:.05*K},ring:{rz:.5*K}});Wa()}}let H,c={models:{},reset:a=>{c.canvas=a;c.objs=0;c.current={};c.next={};c.textures={};c.gl=a.getContext("webgl2");c.gl.blendFunc(770,771);c.gl.activeTexture(33984);c.program=c.gl.createProgram();c.gl.enable(2884);c.gl.shaderSource(H=c.gl.createShader(35633),"#version 300 es\n      precision highp float;                        // Set default float precision\n      in vec4 pos, col, uv, normal;                 // Vertex attributes: position, color, texture coordinates, normal (if any)\n      uniform mat4 pv, eye, m, im;                  // Uniform transformation matrices: projection * view, eye, model, inverse model\n      uniform vec4 bb;                              // If the current shape is a billboard: bb = [w, h, 1.0, 0.0]\n      out vec4 v_pos, v_col, v_uv, v_normal;        // Varyings sent to the fragment shader: position, color, texture coordinates, normal (if any)\n      void main() {                                 \n        gl_Position = pv * (                        // Set vertex position: p * v * v_pos\n          v_pos = bb.z > 0.                         // Set v_pos varying:\n          ? m[3] + eye * (pos * bb)                 // Billboards always face the camera:  p * v * distance + eye * (position * [w, h, 1.0, 0.0])\n          : m * pos                                 // Other objects rotate normally:      p * v * m * position\n        );                                          \n        v_col = col;                                // Set varyings \n        v_uv = uv;\n        v_normal = transpose(inverse(m)) * normal;  // recompute normals to match model thansformation\n      }");
c.gl.compileShader(H);c.gl.attachShader(c.program,H);console.log("vertex shader:",c.gl.getShaderInfoLog(H)||"OK");c.gl.shaderSource(H=c.gl.createShader(35632),"#version 300 es\n      precision highp float;                  // Set default float precision\n      in vec4 v_pos, v_col, v_uv, v_normal;   // Varyings received from the vertex shader: position, color, texture coordinates, normal (if any)\n      uniform vec3 light;                     // Uniform: light direction, smooth normals enabled\n      uniform vec4 o;                         // options [smooth, shading enabled, ambient, mix]\n      uniform sampler2D sampler;              // Uniform: 2D texture\n      out vec4 c;                             // Output: final fragment color\n\n      // The code below displays colored / textured / shaded fragments\n      void main() {\n        c = mix(texture(sampler, v_uv.xy), v_col, o[3]);  // base color (mix of texture and rgba)\n        if(o[1] > 0.){                                    // if lighting/shading is enabled:\n          c = vec4(                                       // output = vec4(base color RGB * (directional shading + ambient light)), base color Alpha\n            c.rgb * (max(0., dot(light, -normalize(       // Directional shading: compute dot product of light direction and normal (0 if negative)\n              o[0] > 0.                                   // if smooth shading is enabled:\n              ? vec3(v_normal.xyz)                        // use smooth normals passed as varying\n              : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))   // else, compute flat normal by making a cross-product with the current fragment and its x/y neighbours\n            )))\n            + o[2]),                                      // add ambient light passed as uniform\n            c.a                                           // use base color's alpha\n          );\n        }\n      }");
c.gl.compileShader(H);c.gl.attachShader(c.program,H);console.log("fragment shader:",c.gl.getShaderInfoLog(H)||"OK");c.gl.linkProgram(c.program);c.gl.useProgram(c.program);console.log("program:",c.gl.getProgramInfoLog(c.program)||"OK");c.gl.clearColor(1,1,1,1);c.clearColor=b=>c.gl.clearColor(...c.col(b));c.clearColor("fff");c.gl.enable(2929);c.light({y:-1});c.camera({fov:30});setTimeout(c.draw,16)},setState:(a,b,d)=>{var e;(e=a).n||(e.n="o"+c.objs++);a.size&&(a.w=a.h=a.d=a.size);a.t&&a.t.width&&!c.textures[a.t.id]&&
(d=c.gl.createTexture(),c.gl.pixelStorei(37441,!0),c.gl.bindTexture(3553,d),c.gl.pixelStorei(37440,1),c.gl.texImage2D(3553,0,6408,6408,5121,a.t),c.gl.generateMipmap(3553),c.textures[a.t.id]=d);if(a.fov){const {near:f=1,far:n=1E3,fov:q,aspect:z=canvas.width/canvas.height}=a;d=1/Math.tan(q*Math.PI/180);e=1/(f-n);c.projection=new DOMMatrix([d/z,0,0,0,0,d,0,0,0,0,(n+f)*e,-1,0,0,2*f*n*e,0])}a={type:b,...(c.current[a.n]=c.next[a.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0}),...a,f:0};
let h,k;null==(h=c.models[a.type])||!h.vertices||null!=(k=c.models)&&k[a.type].verticesBuffer||(c.gl.bindBuffer(34962,c.models[a.type].verticesBuffer=c.gl.createBuffer()),c.gl.bufferData(34962,new Float32Array(c.models[a.type].vertices),35044),!c.models[a.type].normals&&c.smooth&&c.smooth(a),c.models[a.type].normals&&(c.gl.bindBuffer(34962,c.models[a.type].normalsBuffer=c.gl.createBuffer()),c.gl.bufferData(34962,new Float32Array(c.models[a.type].normals.flat()),35044)));let m;(null==(m=c.models[a.type])?
0:m.uv)&&!c.models[a.type].uvBuffer&&(c.gl.bindBuffer(34962,c.models[a.type].uvBuffer=c.gl.createBuffer()),c.gl.bufferData(34962,new Float32Array(c.models[a.type].uv),35044));let l;(null==(l=c.models[a.type])?0:l.indices)&&!c.models[a.type].indicesBuffer&&(c.gl.bindBuffer(34963,c.models[a.type].indicesBuffer=c.gl.createBuffer()),c.gl.bufferData(34963,new Uint16Array(c.models[a.type].indices),35044));a.t?a.t&&!a.mix&&(a.mix=0):a.mix=1;c.next[a.n]=a},draw:(a,b,d,e,h=[])=>{b=a-c.lastFrame;c.lastFrame=
a;requestAnimationFrame(c.draw);c.next.camera.g&&c.render(c.next[c.next.camera.g],b,1);d=c.animation("camera");let k,m;(null==(k=c.next)?0:null==(m=k.camera)?0:m.g)&&d.preMultiplySelf(c.next[c.next.camera.g].M||c.next[c.next.camera.g].m);c.gl.uniformMatrix4fv(c.gl.getUniformLocation(c.program,"eye"),!1,d.toFloat32Array());d.invertSelf();d.preMultiplySelf(c.projection);c.gl.uniformMatrix4fv(c.gl.getUniformLocation(c.program,"pv"),!1,d.toFloat32Array());c.gl.clear(16640);for(e in c.next)c.next[e].t||
1!=c.col(c.next[e].b)[3]?h.push(c.next[e]):c.render(c.next[e],b);h.sort((l,f)=>c.dist(f)-c.dist(l));c.gl.enable(3042);for(e of h)["plane","billboard"].includes(e.type)&&c.gl.depthMask(0),c.render(e,b),c.gl.depthMask(1);c.gl.disable(3042);c.gl.uniform3f(c.gl.getUniformLocation(c.program,"light"),c.lerp("light","x"),c.lerp("light","y"),c.lerp("light","z"))},render:(a,b,d=["camera","light","group"].includes(a.type),e)=>{a.t&&(c.gl.bindTexture(3553,c.textures[a.t.id]),c.gl.uniform1i(c.gl.getUniformLocation(c.program,
"sampler"),0));a.f<a.a&&(a.f+=b);a.f>a.a&&(a.f=a.a);c.next[a.n].m=c.animation(a.n);c.next[a.g]&&c.next[a.n].m.preMultiplySelf(c.next[a.g].M||c.next[a.g].m);c.gl.uniformMatrix4fv(c.gl.getUniformLocation(c.program,"m"),!1,(c.next[a.n].M||c.next[a.n].m).toFloat32Array());c.gl.uniformMatrix4fv(c.gl.getUniformLocation(c.program,"im"),!1,(new DOMMatrix(c.next[a.n].M||c.next[a.n].m)).invertSelf().toFloat32Array());d||(c.gl.bindBuffer(34962,c.models[a.type].verticesBuffer),c.gl.vertexAttribPointer(e=c.gl.getAttribLocation(c.program,
"pos"),3,5126,!1,0,0),c.gl.enableVertexAttribArray(e),c.models[a.type].uvBuffer&&(c.gl.bindBuffer(34962,c.models[a.type].uvBuffer),c.gl.vertexAttribPointer(e=c.gl.getAttribLocation(c.program,"uv"),2,5126,!1,0,0),c.gl.enableVertexAttribArray(e)),(a.s||c.models[a.type].customNormals)&&c.models[a.type].normalsBuffer&&(c.gl.bindBuffer(34962,c.models[a.type].normalsBuffer),c.gl.vertexAttribPointer(e=c.gl.getAttribLocation(c.program,"normal"),3,5126,!1,0,0),c.gl.enableVertexAttribArray(e)),c.gl.uniform4f(c.gl.getUniformLocation(c.program,
"o"),a.s,(3<a.mode||3<c.gl[a.mode])&&!a.ns?1:0,c.ambientLight||.2,a.mix),c.gl.uniform4f(c.gl.getUniformLocation(c.program,"bb"),a.w,a.h,"billboard"==a.type,0),c.models[a.type].indicesBuffer&&c.gl.bindBuffer(34963,c.models[a.type].indicesBuffer),c.gl.vertexAttrib4fv(c.gl.getAttribLocation(c.program,"col"),c.col(a.b)),c.models[a.type].indicesBuffer?c.gl.drawElements(+a.mode||c.gl[a.mode],c.models[a.type].indices.length,5123,0):c.gl.drawArrays(+a.mode||c.gl[a.mode],0,c.models[a.type].vertices.length/
3))},lerp:(a,b)=>{let d;return(null==(d=c.next[a])?0:d.a)?c.current[a][b]+c.next[a].f/c.next[a].a*(c.next[a][b]-c.current[a][b]):c.next[a][b]},animation:(a,b=new DOMMatrix)=>c.next[a]?b.translateSelf(c.lerp(a,"x"),c.lerp(a,"y"),c.lerp(a,"z")).rotateSelf(c.lerp(a,"rx"),c.lerp(a,"ry"),c.lerp(a,"rz")).scaleSelf(c.lerp(a,"w"),c.lerp(a,"h"),c.lerp(a,"d")):b,dist:(a,b=c.next.camera)=>(null==a?0:a.m)&&(null==b?0:b.m)?(b.m.m41-a.m.m41)**2+(b.m.m42-a.m.m42)**2+(b.m.m43-a.m.m43)**2:0,ambient:a=>c.ambientLight=
a,col:a=>[...a.replace("#","").match(5>a.length?/./g:/../g).map(b=>("0x"+b)/(5>a.length?15:255)),1],add:(a,b)=>{c.models[a]=b;b.normals&&(c.models[a].customNormals=1);c[a]=d=>c.setState(d,a)},group:a=>c.setState(a,"group"),move:(a,b)=>setTimeout(()=>{c.setState(a)},b||1),delete:(a,b)=>setTimeout(()=>{delete c.next[a]},b||1),camera:(a,b)=>setTimeout(()=>{c.setState(a,a.n="camera")},b||1),light:(a,b)=>b?setTimeout(()=>{c.setState(a,a.n="light")},b):c.setState(a,a.n="light"),smooth:(a,b={},d=[],e,h,
k,m,l,f,n,q,z,u,A,B,v)=>{c.models[a.type].normals=[];for(k=0;k<c.models[a.type].vertices.length;k+=3)d.push(c.models[a.type].vertices.slice(k,k+3));(e=c.models[a.type].indices)?h=1:(e=d,h=0);for(k=0;k<2*e.length;k+=3){m=k%e.length;l=d[q=h?c.models[a.type].indices[m]:m];f=d[z=h?c.models[a.type].indices[m+1]:m+1];n=d[u=h?c.models[a.type].indices[m+2]:m+2];B=[f[0]-l[0],f[1]-l[1],f[2]-l[2]];v=[n[0]-f[0],n[1]-f[1],n[2]-f[2]];A=k>m?[0,0,0]:[B[1]*v[2]-B[2]*v[1],B[2]*v[0]-B[0]*v[2],B[0]*v[1]-B[1]*v[0]];let w,
S;(w=b)[S=l[0]+"_"+l[1]+"_"+l[2]]||(w[S]=[0,0,0]);let I,ba;(I=b)[ba=f[0]+"_"+f[1]+"_"+f[2]]||(I[ba]=[0,0,0]);let C,r;(C=b)[r=n[0]+"_"+n[1]+"_"+n[2]]||(C[r]=[0,0,0]);c.models[a.type].normals[q]=b[l[0]+"_"+l[1]+"_"+l[2]]=b[l[0]+"_"+l[1]+"_"+l[2]].map((N,G)=>N+A[G]);c.models[a.type].normals[z]=b[f[0]+"_"+f[1]+"_"+f[2]]=b[f[0]+"_"+f[1]+"_"+f[2]].map((N,G)=>N+A[G]);c.models[a.type].normals[u]=b[n[0]+"_"+n[1]+"_"+n[2]]=b[n[0]+"_"+n[1]+"_"+n[2]].map((N,G)=>N+A[G])}}};c.add("plane",{vertices:[.5,.5,0,-.5,
.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]});c.add("billboard",c.models.plane);const T=window.document;var M={lockMove:{x:0,y:0},move:{x:0,y:0},wheel:0,click:null,lockElt:null,down:{},isLocked:()=>!!T.pointerLockElement,async lock(){T.pointerLockElement||await this.lockElt.requestPointerLock()},async toggleLock(){T.pointerLockElement?await this.unlock():await this.lock()},async unlock(){await T.exitPointerLock()},getLockMove(){const a={...this.lockMove};this.lockMove.x=
0;this.lockMove.y=0;return a},getWheel(){const a=this.wheel;this.wheel=0;return a},getClick(){const a=this.click;this.click=null;return a},setup(a={}){this.lockElt=a.lockElt;onmousemove=d=>{const e=this[T.pointerLockElement?"lockMove":"move"];e.x+=d.movementX;e.y+=d.movementY};onkeydown=d=>{this.down[d.key]=!0;!d.repeat&&a.keys&&a.keys[d.key]&&(a.keys[d.key](),d.preventDefault())};onkeyup=d=>{this.down[d.key]=!1};onwheel=d=>{this.wheel+=d.deltaY};const b=d=>{const {clientX:e,clientY:h,button:k}=d;
this.click={clientX:e,clientY:h,button:k,left:0===k,right:2===k,locked:!!T.pointerLockElement}};oncontextmenu=onclick=b}};const Q=document,{sin:U,cos:V,atan2:sa,PI:L,sqrt:Fa}=Math;class t{constructor(a=0,b=0,d=0){"object"===typeof a&&(b=a.y,d=a.z,a=a.x);this.x=a;this.y=b;this.z=d}copy(){return new t(this.x,this.y,this.z)}copyTo(a){a.x=this.x;a.y=this.y;a.z=this.z}add(a){return new t(this.x+a.x,this.y+a.y,this.z+a.z)}sub(a){return new t(this.x-a.x,this.y-a.y,this.z-a.z)}length(){return this.lengthSquared()**
.5}lengthSquared(){return this.x**2+this.y**2+this.z**2}distance(a){return this.distanceSquared(a)**.5}distanceSquared(a){return(this.x-a.x)**2+(this.y-a.y)**2+(this.z-a.z)**2}normalize(a=1){const b=this.length();return b?this.scale(a/b):new t(0,a,0)}scale(a){return new t(this.x*a,this.y*a,this.z*a)}cross(a){const {x:b,y:d,z:e}=this;return new t(d*a.z-e*a.y,e*a.x-b*a.z,b*a.y-d*a.x)}rotate(a,b,d){return this.rotateX(a).rotateY(b).rotateZ(d)}rotateX(a=0){var b=this.x,d=this.y*V(a)-this.z*U(a);a=this.y*
U(a)+this.z*V(a);return new t(b,d,a)}rotateY(a=0){var b=this.x*V(a)+this.z*U(a),d=this.y;a=-this.x*U(a)+this.z*V(a);return new t(b,d,a)}rotateZ(a=0){var b=this.x*V(a)-this.y*U(a);a=this.x*U(a)+this.y*V(a);return new t(b,a,this.z)}toAngles(a){let {x:b,y:d,z:e}=this;a&&(b=a.x-b,d=a.y-d,e=a.z-e);a=sa(d,b);const h=sa(-e,Fa(b*b+d*d));var k=0;if(0!==b||0!==d)k=Fa(b*b+d*d),k=sa(e,k);return{roll:k,pitch:h,yaw:a}}toWAngles(a){const {roll:b,pitch:d,yaw:e}=this.toAngles(a);return{rx:180/L*b,ry:180/L*d,rz:180/
L*e}}}const {PI:Za}=Math,Ia=2*Za;class $a{constructor(a){this.seed=a}rand(a=1,b=0){this.seed^=this.seed<<13;this.seed^=this.seed>>>17;this.seed^=this.seed<<5;return b+(a-b)*Math.abs(this.seed%1E9)/1E9}int(a,b=0){return Math.floor(this.rand(a,b))}sign(){return 2*this.randInt(2)-1}}let p;const ya=new $a(1234),E=(a=12500)=>ya.rand(-a,a),ia={x:0,y:0,z:6250,rx:-90,ry:0,rz:0,vel:{x:0,y:0,z:0},thrust:{x:0,y:0,z:0},thrustForce:.1,fireCooldown:0,r:2,passType:"ship",passthru:["plasma"],shieldOpacity:0,sight:1500,
aggro:0,thrustCooldown:0,hp:5,maxHp:5,facing:{x:0,y:1,z:0}},Ka={...structuredClone(ia),thrustForce:.002,passType:"klaxShip",passthru:["klaxPlasma"],facing:{x:1,y:0,z:0}},xa=[],fa=[ia],ha={},Ma={volume:.3,sampleRate:44100,x:new AudioContext,play:function(...a){return this.playSamples(this.buildSamples(...a))},playSamples:function(...a){const b=this.x.createBuffer(a.length,a[0].length,this.sampleRate),d=this.x.createBufferSource();a.map((e,h)=>b.getChannelData(h).set(e));d.buffer=b;d.connect(this.x.destination);
d.start();return d},buildSamples:function(a=1,b=.05,d=220,e=0,h=0,k=.1,m=0,l=1,f=0,n=0,q=0,z=0,u=0,A=0,B=0,v=0,w=0,S=1,I=0,ba=0){let C=2*Math.PI;var r=this.sampleRate;let N=f*=500*C/r/r;b=d*=(1+2*b*Math.random()-b)*C/r;let G=[],O=0,ab=0,y=0,ca=1,bb=0,cb=0,J=0,W;e=e*r+9;I*=r;h*=r;k*=r;w*=r;n*=500*C/r**3;B*=C/r;q*=C/r;z*=r;u=u*r|0;for(W=e+I+h+k+w|0;y<W;G[y++]=J)++cb%(100*v|0)||(J=m?1<m?2<m?3<m?Math.sin((O%C)**3):Math.max(Math.min(Math.tan(O),1),-1):1-(2*O/C%2+2)%2:1-4*Math.abs(Math.round(O/C)-O/C):
Math.sin(O),J=(u?1-ba+ba*Math.sin(C*y/u):1)*(0<J?1:-1)*Math.abs(J)**l*a*this.volume*(y<e?y/e:y<e+I?1-(y-e)/I*(1-S):y<e+I+h?S:y<W-w?(W-y-w)/k*S:0),J=w?J/2+(w>y?0:(y<W-w?1:(W-y)/w)*G[y-w|0]/2):J),r=(d+=f+=n)*Math.cos(B*ab++),O+=r-r*A*(1-1E9*(Math.sin(y)+1)%2),ca&&++ca>z&&(d+=q,b+=q,ca=0),!u||++bb%u||(d=b,f=N,ca=ca||1);return G},getNote:function(a=0,b=440){return b*2**(a/12)}},{min:na,max:R,round:pa,abs:Ya}=Math;let Z,oa={};const Qa=1/12E3;var ra=ra=K=0;const aa=1E3/60,qa={back:-1.5,up:.6,rx:80,ry:0,
rz:0},x={fov:30,targetFov:30,lastFov:31,aspect:1,near:.5,far:25E3},F={rx:-90,ry:0,rz:0},la=["Check steering: [Tab] to toggle mouse-lock","Thrusters: [W]","Fire weapons: [Space] or [Click]"].map(a=>({t:a,done:0})),Va={plasma:{vScale:25,tScale:5E-4,damage:1,size:1,sound:[,.1,295,.02,.01,.08,,1.72,-3.5,.2,,,,.2,,,.08,.62,.09]},photon:{vScale:15,tScale:1E-4,damage:3,size:1,sound:[2.06,.35,212,.05,.08,.01,,1.66,-4.8,.2,50,,,1.7,,.5,.28,.65,.02]},klaxPlasma:{vScale:25,tScale:5E-4,damage:1,size:10,sound:[.3,
.4,241,.04,.03,.08,,.46,-7.7,,,,,,,.2,,.53,.05,.2]}};addEventListener("DOMContentLoaded",()=>{Oa();setInterval(Xa,aa)});window.g={input:M}})();
