(function(){var C;function Y(a="cube",{x:c=.5,y:d=.5,z:e=.5}={}){b.add(a,{vertices:[c,d,e,-c,d,e,-c,-d,e,c,d,e,-c,-d,e,c,-d,e,c,d,-e,c,d,e,c,-d,e,c,d,-e,c,-d,e,c,-d,-e,c,d,-e,-c,d,-e,-c,d,e,c,d,-e,-c,d,e,c,d,e,-c,d,e,-c,d,-e,-c,-d,-e,-c,d,e,-c,-d,-e,-c,-d,e,-c,d,-e,c,d,-e,c,-d,-e,-c,d,-e,c,-d,-e,-c,-d,-e,c,-d,e,-c,-d,e,-c,-d,-e,c,-d,e,-c,-d,-e,c,-d,-e],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,
0]})}function R(a,c=0,d=1){return a<c?c:a>d?d:a}function S(a=1,c=0){return c+Math.random()*(a-c)}function Z(a,c){return a.rotate(x/180*c.rx,x/180*c.ry,x/180*c.rz)}function aa(a){const {facing:c}=a;return Z(new n(c,void 0,void 0),a)}function qa(a,c){let {rx:d,ry:e,rz:g}=a;d+=c.rx;e+=c.ry;g+=c.rz;return{rx:d,ry:e,rz:g}}function t(a,c){for(let d=0;d<a;d+=1)c(d,a)}function T(a){U[a].done||(U[a].done=1,ba())}function ba(){H.getElementById("goals").innerHTML=U.map(({t:a,done:c})=>`<li class="${c?"done":
""}">${a}</li>`).join("")}function I(a,c){return{x:c*Math.cos(a),y:c*Math.sin(a)}}function ca(a,c){const d=H.getElementById(a),e=d||H.createElement("canvas");e.id=a;e.width=e.height=c;d||H.getElementById("loaded").appendChild(e);return[e,e.getContext("2d"),c/2]}function ra(a){const [c,d]=ca(a,800);t(1400,()=>{d.rect(q.int(0,800),q.int(0,800),1,1)});d.fillStyle="#ebd694";d.fill();return c}function O(a=4,c="#f00",d,e=.4,g=600){const [f,h,k]=ca(d,g);h.clearRect(0,0,g,g);h.beginPath();const l=sa/a;t(a,
m=>{const {x:y,y:P}=I(l*m,k);h.lineTo(k+y,k+P);const {x:Q,y:D}=I(l*m+l/2,k*e);h.lineTo(k+Q,k+D)});h.fillStyle=c;h.fill();return f}function ta(a){const c=`k${a}`;var d={x:q.rand(-499,499),y:q.rand(-499,499),z:q.rand(-499,499)};a={n:c,...structuredClone(ua),...d,size:5,radius:5};b.group({n:c,g:"system",...d});const e={g:c,size:2.5,x:-1.5,b:"372b4e"};d={g:c,size:2,b:"471b6e"};b.cube({...e,n:c+"c",rx:45,b:"471b6e"});t(4,g=>{b.cube({...e,n:`${c}cc${g}`,x:-2-g,size:2.5-.5*g})});b.pyramid({n:c+"nose",rz:-90,
g:c,size:1.5,b:"90d59c"});b.longRect({...d,n:c+"wing1",y:2,rx:90,ry:45,rz:-45});b.longRect({...d,n:c+"wing2",y:2,x:1.5,rx:90,ry:45,rz:45,b:"471b6e"});b.longRect({...d,n:c+"wing3",y:-2,rx:90,ry:45,rz:45});b.longRect({...d,n:c+"wing4",y:-2,x:1.5,rx:90,ry:45,rz:-45,b:"471b6e"});b.sphere({n:c+"shield",g:c,size:10,b:"ebd69403"});u.push(a);v[a.n]=a;da.push(a)}function va(){var a=H.getElementById("canvas");r.setup({lockElt:a,keys:{Tab:()=>{T(0);r.toggleLock()}}});J.tf=O(9,"#ebd694","tf",.3);J.plasma=O(11,
"#90d59c","plasma",.2);J.photon=O(13,"#702782","photon",.5);a.addEventListener("click",()=>{r.lock()});b.reset(a);b.clearColor("2a242b");b.light({x:-1,y:-1.2,z:0});b.ambient(.8);Y("ringWall",{y:10,z:5});Y("longRect",{x:.2,y:.2});b.group({n:"system"});["sun","ring","p1","p2"].forEach(d=>b.group({n:d,g:"system"}));["ship","skybox"].forEach(d=>b.group({n:d}));a=O(16,"#de8b6f88","sun",.7);b.sphere({n:"outerSun",g:"sun",size:50,b:"#de8b6f88"});b.sphere({n:"innerSun",g:"sun",size:46,b:"#de8b6f"});b.billboard({n:"sunFlare",
g:"sun",size:60,b:"#de8b6f",t:a});b.sphere({n:"planet1",g:"p1",...I(.5,300),size:20,b:"775b5b"});b.sphere({n:"planet2",g:"p2",...I(.7,400),size:8,b:"b0455a"});a=ra("sf");[{z:-499,b:"0000",t:a},{y:-499,rx:-90,b:"0000",t:a},{y:499,rx:90,b:"0000",t:a},{x:-499,ry:90,b:"0000",t:a},{x:499,ry:-90,b:"0000",t:a},{z:499,rx:180,b:"0000",t:a}].forEach((d,e)=>{b.plane({b:"000",...d,n:`skybox${e}`,g:"skybox",size:998})});b.pyramid({n:"shipBase",g:"ship",size:.3,b:"5796a1"});b.cube({n:"shipCube",g:"ship",y:-.15,
size:.24,b:"5796a1"});a={n:"shipEngine1",g:"ship",ry:45,rx:90,x:-.18,y:-.21,size:.3,b:"8bc7bf"};b.longRect(a);b.longRect({...a,n:"shipEngine2",x:-a.x});b.cube({n:"shipEngineBack1",g:"ship",x:-.18,y:-.345,size:.075,b:"5796a1"});b.cube({n:"shipEngineBack2",g:"ship",x:.18,y:-.345,size:.075,b:"5796a1"});t(5,ta);const c=2*Math.PI;t(32,(d,e)=>{var g=0===d?0:c*d/e;e=180/x*g;let {x:f,y:h}=I(g,200);g=`r${d}`;b.group({n:g,g:"ring"});b.ringWall({n:`ring${d}`,g,x:f,y:h,rz:e,size:2,b:"5796a1"});b.cube({n:`ringBuilding${d}`,
g,x:f,y:h,rz:e,size:5,b:"478691"})});t(200,d=>{b.billboard({n:`litter${d}`,g:"system",x:q.rand(-499,499),y:q.rand(-499,499),z:q.rand(-499,499),size:1,b:"555"})});t(50,d=>{d={n:`crate${d}`,passType:"crate",passthru:["crate"],g:"system",x:q.rand(-499,499),y:q.rand(-499,499),z:q.rand(-499,499),vel:{...(new n(void 0,void 0,void 0))},size:3,r:2,b:"de8b6f",rx:S(0,359),ry:S(0,359),rz:S(0,359),hp:3};u.push(d);v[d.n]=d;b.cube(d)});ba()}function ea(a,c=0){const {x:d,y:e,z:g}=aa(a).scale(c);a.thrust={x:d,y:e,
z:g}}function wa(a,c){["x","y","z"].forEach(d=>{let e=a.thrust?a.thrust[d]||0:0;0===e&&0!==a.friction&&(e=1E-4*-a.vel[d]);a.vel[d]=R(a.vel[d]+e/(a.mass||1)/c,-1E3,1E3);1E-4>a.vel[d]&&-1E-4<a.vel[d]&&(a.vel[d]=0);a[d]=R(a[d]+a.vel[d]*c,-499,499)})}function fa(a,c){a.damage&&c.hp&&(c.hp-=a.damage,a.decay=0,0>=c.hp&&(c.decay=0));a.aggro+=1;c.aggro+=1;a.shieldOpacity+=5;c.shieldOpacity+=5}function xa(a,c,d){a.collided=c;c.collided=a;fa(a,c);fa(c,a);d=(new n(c,void 0,void 0)).sub(a).normalize().scale((a.r+
c.r-d)/2);(new n(a,void 0,void 0)).sub(d).copyTo(a);(new n(c,void 0,void 0)).add(d).copyTo(c);["x","y","z"].forEach(e=>{const g=a.mass||1,f=c.mass||1,h=g+f,k=a.vel[e],l=c.vel[e];a.vel[e]=(g-f)/h*k+2*f/h*l;c.vel[e]=2*g/h*k+(f-g)/h*l})}function ya(a){t(a.length,c=>{za(a[c],a)})}function za(a,c){a.collided||t(c.length,d=>{d=c[d];if(!(a.passthru&&a.passthru.includes(d.passType)||d.passthru&&d.passthru.includes(a.passType)||a===d||d.collided)){var e=(new n(a,void 0,void 0)).distance(d);e<=a.r+d.r&&xa(a,
d,e)}})}function Aa(a={}){Object.keys(a).forEach(c=>{b.move({n:c,...a[c]},0)})}function ha(a,c,d=.01){["rx","ry","rz"].forEach(e=>{var g=a[e];var f=c[e];g+=R(d)*(f-g);return a[e]=g})}function ia(a,c,d,e){const {vScale:g,tScale:f,damage:h}=Ba[a];a=J[a];const {x:k,y:l,z:m}=c,y=aa(c);c=y.scale(g).add(c.vel);d={n:"plasma"+String(Number(new Date)),g:"system",passType:d,x:k,y:l,z:m,vel:{...c},thrust:{...y.scale(f)},friction:0,decay:5,damage:h,r:.5,passthru:e,mass:.01};u.push(d);v[d.n]=d;b.billboard({...d,
size:1,t:a})}function Ca(){const a=K/1E3;if(!r.down.p){var c=r.down.w?.01:0;r.down.s&&(c=-.005);ea(p,c);0===c?(b.delete("shipEngineIgnite1"),b.delete("shipEngineIgnite2")):(T(1),c={g:"ship",y:-.393,rx:90,size:.2,t:J.tf},b.plane({...c,n:"shipEngineIgnite1",x:-.18}),b.plane({...c,n:"shipEngineIgnite2",x:.18}));c=r.getClick();0===p.fireCooldown&&(r.down[" "]||c&&c.locked)&&(T(2),ia(c&&c.right?"photon":"plasma",p,"plasma",["ship","plasma"]),p.fireCooldown=.3);da.forEach(f=>{{var h=new n(f,void 0,void 0);
const k=h.distance(p);k>2*f.sight?f.aggro=L(0,f.aggro-=.1):k<=f.sight&&(f.aggro=L(1,f.aggro));f.aggro&&(h=h.toWAngles(p),ha(f,h,.01),f.thrustCooldown?f.thrustCooldown=L(f.thrustCooldown-a,0):(ea(f,.003),f.thrustCooldown=5),0===f.fireCooldown?(ia("plasma",f,"klaxPlasma",["klaxShip","klaxPlasma"]),f.fireCooldown=1):f.fireCooldown=L(f.fireCooldown-a,0))}});ya(u);u.forEach(f=>{f.collided=0;wa(f,a)});c=r.getLockMove();z.ry-=c.x/10;z.rx-=c.y/10;ha(p,z,.05);c=Z(new n(0,V.back,V.up),z);b.camera({...c,...qa(V,
z),a:1E3});var {rx:d,ry:e,rz:g}=p;b.move({n:"ship",rx:d,ry:e,rz:g});p.fireCooldown=L(p.fireCooldown-a,0);Object.keys(v).forEach(f=>{const h=v[f];"number"===typeof h.decay&&(h.decay-=a,0>=h.decay&&(b.delete(h.n),delete v[f],f=u.findIndex(k=>k.n===h.n),u.splice(f,1)))});C+=K/90;W+=K/100;Aa({...v,system:{x:-p.x,y:-p.y,z:-p.z,a:K},innerSun:{rx:C,ry:W},p1:{rz:.1*C},p2:{rz:.15*C},ring:{rz:.5*C}})}}let w,b={models:{},reset:a=>{b.canvas=a;b.objs=0;b.current={};b.next={};b.textures={};b.gl=a.getContext("webgl2");
b.gl.blendFunc(770,771);b.gl.activeTexture(33984);b.program=b.gl.createProgram();b.gl.enable(2884);b.gl.shaderSource(w=b.gl.createShader(35633),"#version 300 es\n      precision highp float;                        // Set default float precision\n      in vec4 pos, col, uv, normal;                 // Vertex attributes: position, color, texture coordinates, normal (if any)\n      uniform mat4 pv, eye, m, im;                  // Uniform transformation matrices: projection * view, eye, model, inverse model\n      uniform vec4 bb;                              // If the current shape is a billboard: bb = [w, h, 1.0, 0.0]\n      out vec4 v_pos, v_col, v_uv, v_normal;        // Varyings sent to the fragment shader: position, color, texture coordinates, normal (if any)\n      void main() {                                 \n        gl_Position = pv * (                        // Set vertex position: p * v * v_pos\n          v_pos = bb.z > 0.                         // Set v_pos varying:\n          ? m[3] + eye * (pos * bb)                 // Billboards always face the camera:  p * v * distance + eye * (position * [w, h, 1.0, 0.0])\n          : m * pos                                 // Other objects rotate normally:      p * v * m * position\n        );                                          \n        v_col = col;                                // Set varyings \n        v_uv = uv;\n        v_normal = transpose(inverse(m)) * normal;  // recompute normals to match model thansformation\n      }");
b.gl.compileShader(w);b.gl.attachShader(b.program,w);console.log("vertex shader:",b.gl.getShaderInfoLog(w)||"OK");b.gl.shaderSource(w=b.gl.createShader(35632),"#version 300 es\n      precision highp float;                  // Set default float precision\n      in vec4 v_pos, v_col, v_uv, v_normal;   // Varyings received from the vertex shader: position, color, texture coordinates, normal (if any)\n      uniform vec3 light;                     // Uniform: light direction, smooth normals enabled\n      uniform vec4 o;                         // options [smooth, shading enabled, ambient, mix]\n      uniform sampler2D sampler;              // Uniform: 2D texture\n      out vec4 c;                             // Output: final fragment color\n\n      // The code below displays colored / textured / shaded fragments\n      void main() {\n        c = mix(texture(sampler, v_uv.xy), v_col, o[3]);  // base color (mix of texture and rgba)\n        if(o[1] > 0.){                                    // if lighting/shading is enabled:\n          c = vec4(                                       // output = vec4(base color RGB * (directional shading + ambient light)), base color Alpha\n            c.rgb * (max(0., dot(light, -normalize(       // Directional shading: compute dot product of light direction and normal (0 if negative)\n              o[0] > 0.                                   // if smooth shading is enabled:\n              ? vec3(v_normal.xyz)                        // use smooth normals passed as varying\n              : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))   // else, compute flat normal by making a cross-product with the current fragment and its x/y neighbours\n            )))\n            + o[2]),                                      // add ambient light passed as uniform\n            c.a                                           // use base color's alpha\n          );\n        }\n      }");
b.gl.compileShader(w);b.gl.attachShader(b.program,w);console.log("fragment shader:",b.gl.getShaderInfoLog(w)||"OK");b.gl.linkProgram(b.program);b.gl.useProgram(b.program);console.log("program:",b.gl.getProgramInfoLog(b.program)||"OK");b.gl.clearColor(1,1,1,1);b.clearColor=c=>b.gl.clearColor(...b.col(c));b.clearColor("fff");b.gl.enable(2929);b.light({y:-1});b.camera({fov:30});setTimeout(b.draw,16)},setState:(a,c,d)=>{let e;(e=a).n||(e.n="o"+b.objs++);a.size&&(a.w=a.h=a.d=a.size);a.t&&a.t.width&&!b.textures[a.t.id]&&
(d=b.gl.createTexture(),b.gl.pixelStorei(37441,!0),b.gl.bindTexture(3553,d),b.gl.pixelStorei(37440,1),b.gl.texImage2D(3553,0,6408,6408,5121,a.t),b.gl.generateMipmap(3553),b.textures[a.t.id]=d);a.fov&&(b.projection=new DOMMatrix([1/Math.tan(a.fov*Math.PI/180)/(b.canvas.width/b.canvas.height),0,0,0,0,1/Math.tan(a.fov*Math.PI/180),0,0,0,0,-1001/999,-1,0,0,-2002/999,0]));a={type:c,...(b.current[a.n]=b.next[a.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0}),...a,f:0};let g,f;null==(g=
b.models[a.type])||!g.vertices||null!=(f=b.models)&&f[a.type].verticesBuffer||(b.gl.bindBuffer(34962,b.models[a.type].verticesBuffer=b.gl.createBuffer()),b.gl.bufferData(34962,new Float32Array(b.models[a.type].vertices),35044),!b.models[a.type].normals&&b.smooth&&b.smooth(a),b.models[a.type].normals&&(b.gl.bindBuffer(34962,b.models[a.type].normalsBuffer=b.gl.createBuffer()),b.gl.bufferData(34962,new Float32Array(b.models[a.type].normals.flat()),35044)));let h;(null==(h=b.models[a.type])?0:h.uv)&&
!b.models[a.type].uvBuffer&&(b.gl.bindBuffer(34962,b.models[a.type].uvBuffer=b.gl.createBuffer()),b.gl.bufferData(34962,new Float32Array(b.models[a.type].uv),35044));let k;(null==(k=b.models[a.type])?0:k.indices)&&!b.models[a.type].indicesBuffer&&(b.gl.bindBuffer(34963,b.models[a.type].indicesBuffer=b.gl.createBuffer()),b.gl.bufferData(34963,new Uint16Array(b.models[a.type].indices),35044));a.t?a.t&&!a.mix&&(a.mix=0):a.mix=1;b.next[a.n]=a},draw:(a,c,d,e,g=[])=>{c=a-b.lastFrame;b.lastFrame=a;requestAnimationFrame(b.draw);
b.next.camera.g&&b.render(b.next[b.next.camera.g],c,1);d=b.animation("camera");let f,h;(null==(f=b.next)?0:null==(h=f.camera)?0:h.g)&&d.preMultiplySelf(b.next[b.next.camera.g].M||b.next[b.next.camera.g].m);b.gl.uniformMatrix4fv(b.gl.getUniformLocation(b.program,"eye"),!1,d.toFloat32Array());d.invertSelf();d.preMultiplySelf(b.projection);b.gl.uniformMatrix4fv(b.gl.getUniformLocation(b.program,"pv"),!1,d.toFloat32Array());b.gl.clear(16640);for(e in b.next)b.next[e].t||1!=b.col(b.next[e].b)[3]?g.push(b.next[e]):
b.render(b.next[e],c);g.sort((k,l)=>b.dist(l)-b.dist(k));b.gl.enable(3042);for(e of g)["plane","billboard"].includes(e.type)&&b.gl.depthMask(0),b.render(e,c),b.gl.depthMask(1);b.gl.disable(3042);b.gl.uniform3f(b.gl.getUniformLocation(b.program,"light"),b.lerp("light","x"),b.lerp("light","y"),b.lerp("light","z"))},render:(a,c,d=["camera","light","group"].includes(a.type),e)=>{a.t&&(b.gl.bindTexture(3553,b.textures[a.t.id]),b.gl.uniform1i(b.gl.getUniformLocation(b.program,"sampler"),0));a.f<a.a&&(a.f+=
c);a.f>a.a&&(a.f=a.a);b.next[a.n].m=b.animation(a.n);b.next[a.g]&&b.next[a.n].m.preMultiplySelf(b.next[a.g].M||b.next[a.g].m);b.gl.uniformMatrix4fv(b.gl.getUniformLocation(b.program,"m"),!1,(b.next[a.n].M||b.next[a.n].m).toFloat32Array());b.gl.uniformMatrix4fv(b.gl.getUniformLocation(b.program,"im"),!1,(new DOMMatrix(b.next[a.n].M||b.next[a.n].m)).invertSelf().toFloat32Array());d||(b.gl.bindBuffer(34962,b.models[a.type].verticesBuffer),b.gl.vertexAttribPointer(e=b.gl.getAttribLocation(b.program,"pos"),
3,5126,!1,0,0),b.gl.enableVertexAttribArray(e),b.models[a.type].uvBuffer&&(b.gl.bindBuffer(34962,b.models[a.type].uvBuffer),b.gl.vertexAttribPointer(e=b.gl.getAttribLocation(b.program,"uv"),2,5126,!1,0,0),b.gl.enableVertexAttribArray(e)),(a.s||b.models[a.type].customNormals)&&b.models[a.type].normalsBuffer&&(b.gl.bindBuffer(34962,b.models[a.type].normalsBuffer),b.gl.vertexAttribPointer(e=b.gl.getAttribLocation(b.program,"normal"),3,5126,!1,0,0),b.gl.enableVertexAttribArray(e)),b.gl.uniform4f(b.gl.getUniformLocation(b.program,
"o"),a.s,(3<a.mode||3<b.gl[a.mode])&&!a.ns?1:0,b.ambientLight||.2,a.mix),b.gl.uniform4f(b.gl.getUniformLocation(b.program,"bb"),a.w,a.h,"billboard"==a.type,0),b.models[a.type].indicesBuffer&&b.gl.bindBuffer(34963,b.models[a.type].indicesBuffer),b.gl.vertexAttrib4fv(b.gl.getAttribLocation(b.program,"col"),b.col(a.b)),b.models[a.type].indicesBuffer?b.gl.drawElements(+a.mode||b.gl[a.mode],b.models[a.type].indices.length,5123,0):b.gl.drawArrays(+a.mode||b.gl[a.mode],0,b.models[a.type].vertices.length/
3))},lerp:(a,c)=>{let d;return(null==(d=b.next[a])?0:d.a)?b.current[a][c]+b.next[a].f/b.next[a].a*(b.next[a][c]-b.current[a][c]):b.next[a][c]},animation:(a,c=new DOMMatrix)=>b.next[a]?c.translateSelf(b.lerp(a,"x"),b.lerp(a,"y"),b.lerp(a,"z")).rotateSelf(b.lerp(a,"rx"),b.lerp(a,"ry"),b.lerp(a,"rz")).scaleSelf(b.lerp(a,"w"),b.lerp(a,"h"),b.lerp(a,"d")):c,dist:(a,c=b.next.camera)=>(null==a?0:a.m)&&(null==c?0:c.m)?(c.m.m41-a.m.m41)**2+(c.m.m42-a.m.m42)**2+(c.m.m43-a.m.m43)**2:0,ambient:a=>b.ambientLight=
a,col:a=>[...a.replace("#","").match(5>a.length?/./g:/../g).map(c=>("0x"+c)/(5>a.length?15:255)),1],add:(a,c)=>{b.models[a]=c;c.normals&&(b.models[a].customNormals=1);b[a]=d=>b.setState(d,a)},group:a=>b.setState(a,"group"),move:(a,c)=>setTimeout(()=>{b.setState(a)},c||1),delete:(a,c)=>setTimeout(()=>{delete b.next[a]},c||1),camera:(a,c)=>setTimeout(()=>{b.setState(a,a.n="camera")},c||1),light:(a,c)=>c?setTimeout(()=>{b.setState(a,a.n="light")},c):b.setState(a,a.n="light"),smooth:(a,c={},d=[],e,g,
f,h,k,l,m,y,P,Q,D,A,B)=>{b.models[a.type].normals=[];for(f=0;f<b.models[a.type].vertices.length;f+=3)d.push(b.models[a.type].vertices.slice(f,f+3));(e=b.models[a.type].indices)?g=1:(e=d,g=0);for(f=0;f<2*e.length;f+=3){h=f%e.length;k=d[y=g?b.models[a.type].indices[h]:h];l=d[P=g?b.models[a.type].indices[h+1]:h+1];m=d[Q=g?b.models[a.type].indices[h+2]:h+2];A=[l[0]-k[0],l[1]-k[1],l[2]-k[2]];B=[m[0]-l[0],m[1]-l[1],m[2]-l[2]];D=f>h?[0,0,0]:[A[1]*B[2]-A[2]*B[1],A[2]*B[0]-A[0]*B[2],A[0]*B[1]-A[1]*B[0]];let ja,
ka;(ja=c)[ka=k[0]+"_"+k[1]+"_"+k[2]]||(ja[ka]=[0,0,0]);let la,ma;(la=c)[ma=l[0]+"_"+l[1]+"_"+l[2]]||(la[ma]=[0,0,0]);let na,oa;(na=c)[oa=m[0]+"_"+m[1]+"_"+m[2]]||(na[oa]=[0,0,0]);b.models[a.type].normals[y]=c[k[0]+"_"+k[1]+"_"+k[2]]=c[k[0]+"_"+k[1]+"_"+k[2]].map((M,N)=>M+D[N]);b.models[a.type].normals[P]=c[l[0]+"_"+l[1]+"_"+l[2]]=c[l[0]+"_"+l[1]+"_"+l[2]].map((M,N)=>M+D[N]);b.models[a.type].normals[Q]=c[m[0]+"_"+m[1]+"_"+m[2]]=c[m[0]+"_"+m[1]+"_"+m[2]].map((M,N)=>M+D[N])}}};b.add("plane",{vertices:[.5,
.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]});b.add("billboard",b.models.plane);b.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,
-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]});b.cube=a=>b.setState(a,"cube");b.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]});((a,c,d,e,
g,f,h=[],k=[],l=[],m=20)=>{for(d=0;d<=m;d++)for(e=d*Math.PI/m,a=0;a<=m;a++)c=2*a*Math.PI/m,h.push(+(Math.sin(c)*Math.sin(e)/2).toFixed(6),+(Math.cos(e)/2).toFixed(6),+(Math.cos(c)*Math.sin(e)/2).toFixed(6)),l.push(3.5*Math.sin(a/m),-Math.sin(d/m)),a<m&&d<m&&k.push(g=d*(m+1)+a,f=g+(m+1),g+1,g+1,f,f+1);b.add("sphere",{vertices:h,uv:l,indices:k})})();const E=window.document;var r={lockMove:{x:0,y:0},move:{x:0,y:0},wheel:0,click:null,lockElt:null,down:{},isLocked:()=>!!E.pointerLockElement,async lock(){E.pointerLockElement||
await this.lockElt.requestPointerLock()},async toggleLock(){E.pointerLockElement?await this.unlock():await this.lock()},async unlock(){await E.exitPointerLock()},getLockMove(){const a={...this.lockMove};this.lockMove.x=0;this.lockMove.y=0;return a},getWheel(){const a=this.wheel;this.wheel=0;return a},getClick(){const a=this.click;this.click=null;return a},setup(a={}){this.lockElt=a.lockElt;onmousemove=d=>{const e=this[E.pointerLockElement?"lockMove":"move"];e.x+=d.movementX;e.y+=d.movementY};onkeydown=
d=>{this.down[d.key]=!0;!d.repeat&&a.keys&&a.keys[d.key]&&(a.keys[d.key](),d.preventDefault())};onkeyup=d=>{this.down[d.key]=!1};onwheel=d=>{this.wheel+=d.deltaY};const c=d=>{const {clientX:e,clientY:g,button:f}=d;this.click={clientX:e,clientY:g,button:f,left:0===f,right:2===f,locked:!!E.pointerLockElement}};oncontextmenu=onclick=c}};const {sin:F,cos:G,atan2:X,PI:x,sqrt:pa}=Math;class n{constructor(a=0,c=0,d=0){"object"===typeof a&&(c=a.y,d=a.z,a=a.x);this.x=a;this.y=c;this.z=d}copy(){return new n(this.x,
this.y,this.z)}copyTo(a){a.x=this.x;a.y=this.y;a.z=this.z}add(a){return new n(this.x+a.x,this.y+a.y,this.z+a.z)}sub(a){return new n(this.x-a.x,this.y-a.y,this.z-a.z)}length(){return this.lengthSquared()**.5}lengthSquared(){return this.x**2+this.y**2+this.z**2}distance(a){return this.distanceSquared(a)**.5}distanceSquared(a){return(this.x-a.x)**2+(this.y-a.y)**2+(this.z-a.z)**2}normalize(a=1){const c=this.length();return c?this.scale(a/c):new n(0,a,0)}scale(a){return new n(this.x*a,this.y*a,this.z*
a)}cross(a){const {x:c,y:d,z:e}=this;return new n(d*a.z-e*a.y,e*a.x-c*a.z,c*a.y-d*a.x)}rotate(a,c,d){return this.rotateX(a).rotateY(c).rotateZ(d)}rotateX(a=0){var c=this.x,d=this.y*G(a)-this.z*F(a);a=this.y*F(a)+this.z*G(a);return new n(c,d,a)}rotateY(a=0){var c=this.x*G(a)+this.z*F(a),d=this.y;a=-this.x*F(a)+this.z*G(a);return new n(c,d,a)}rotateZ(a=0){var c=this.x*G(a)-this.y*F(a);a=this.x*F(a)+this.y*G(a);return new n(c,a,this.z)}toAngles(a){let {x:c,y:d,z:e}=this;a&&(c=a.x-c,d=a.y-d,e=a.z-e);
a=X(d,c);const g=X(-e,pa(c*c+d*d));var f=0;if(0!==c||0!==d)f=pa(c*c+d*d),f=X(e,f);return{roll:f,pitch:g,yaw:a}}toWAngles(a){const {roll:c,pitch:d,yaw:e}=this.toAngles(a);return{rx:180/x*c,ry:180/x*d,rz:180/x*e}}}class Da{constructor(a){this.seed=a}rand(a=1,c=0){this.seed^=this.seed<<13;this.seed^=this.seed>>>17;this.seed^=this.seed<<5;return c+(a-c)*Math.abs(this.seed%1E9)/1E9}int(a,c=0){return Math.floor(this.rand(a,c))}sign(){return 2*this.randInt(2)-1}}const {max:L,PI:Ea}=Math,sa=2*Ea,H=document;
var W=W=C=0;const p={x:0,y:0,z:499,rx:-90,ry:0,rz:0,vel:{x:0,y:0,z:-16},thrust:{x:0,y:0,z:0},fireCooldown:0,r:2,passType:"ship",passthru:["plasma"],shieldOpacity:0,sight:700,aggro:0,thrustCooldown:0,hp:5,facing:{x:0,y:1,z:0}},ua={...structuredClone(p),passType:"klaxShip",passthru:["klaxPlasma"],facing:{x:1,y:0,z:0}},da=[],K=1E3/60,V={back:-1.5,up:.51,rx:80,ry:0,rz:0},z={rx:-90,ry:0,rz:0},u=[p],v={},q=new Da(1233),J={},U=["Check steering: [Tab] to toggle mouse-lock","Thrusters: [W]","Fire weapons: [Space] or [Click]"].map(a=>
({t:a,done:0})),Ba={plasma:{vScale:40,tScale:5E-4,damage:1},photon:{vScale:15,tScale:1E-4,damage:3}};addEventListener("DOMContentLoaded",()=>{va();setInterval(Ca,K)});window.g={renderables:v,ship:p,input:r,physicsEnts:u}})();
