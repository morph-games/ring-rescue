!function(m){var s;function c(t,r){for(let e=0;e<t;e+=1)r(e,t)}function d(e,t){return{x:t*Math.cos(e),y:t*Math.sin(e)}}function a(e,t){return e.rotate(w/180*t.rx,w/180*t.ry,w/180*t.rz)}function u(e){var t=e["facing"];return a(new k(t,void 0,void 0),e)}function l(e,t=0,r=1){return e<t?t:r<e?r:e}function j(e,t,r){return t+l(e)*(r-t)}function h(e=1,t=0){return t+Math.random()*(e-t)}function R(e,t){var r=x.getElementById(e),n=r||x.createElement("canvas");return n.id=e,n.width=n.height=t,r||x.getElementById("loaded").appendChild(n),[n,n.getContext("2d"),t/2]}function o(e=4,t="#f00",r,n=.4,o=600){const[i,s,a]=R(r,o),l=(s.clearRect(0,0,o,o),s.beginPath(),Q/e);return c(e,e=>{var{x:t,y:r}=d(l*e,a),{x:t,y:r}=(s.lineTo(a+t,a+r),d(l*e+l/2,a*n));s.lineTo(a+t,a+r)}),s.fillStyle=t,s.fill(),i}function U(e){const t="k"+e;var r={x:M(2e3),y:M(2e3),z:M(2e3)};e={n:t,...structuredClone(te),...r,size:5,r:10},S.group({n:t,g:"system",...r});const n={g:t,size:2.5,x:-1.5,b:"372b4e"};r={g:t,size:2,b:"471b6e"},S.cube({...n,n:t+"c",rx:45,b:"471b6e"}),c(4,e=>{S.cube({...n,n:t+"cc"+e,x:-2-e,size:2.5-.5*e})}),S.pyramid({n:t+"nose",rz:-90,g:t,size:1.5,b:"90d59c"}),S.longRect({...r,n:t+"wing1",y:2,rx:90,ry:45,rz:-45}),S.longRect({...r,n:t+"wing2",y:2,x:1.5,rx:90,ry:45,rz:45,b:"471b6e"}),S.longRect({...r,n:t+"wing3",y:-2,rx:90,ry:45,rz:45}),S.longRect({...r,n:t+"wing4",y:-2,x:1.5,rx:90,ry:45,rz:-45,b:"471b6e"}),S.sphere({n:t+"shield",g:t,size:10,b:"ebd69404"}),B.push(e),_[e.n]=e,re.push(e)}function W(e,r){(S=e).group({n:"system"}),["sun","ring","p1","p2","p3"].forEach(e=>S.group({n:e,g:"system"})),["ship","skybox"].forEach(e=>S.group({n:e})),e=o(16,"#de8b6f88","sun",.7),S.sphere({n:"outerSun",g:"sun",size:500,b:"#de8b6f88"}),S.sphere({n:"innerSun",g:"sun",size:480,b:"#de8b6f"}),S.billboard({n:"sunFlare",g:"sun",size:640,b:"#de8b6f",t:e}),S.sphere({n:"planet1",g:"p1",...d(.5,3e3),size:200,b:"775b5b",s:1}),S.sphere({n:"planet2",g:"p2",...d(.7,4e3),size:120,b:"#b0455a",s:1}),S.sphere({n:"planet3",g:"p3",...d(.7,7e3),size:80,b:"775b5b",s:1}),e=function(e,t){const[r,n]=R(e,800);return c(1400,()=>{n.rect(t.int(0,800),t.int(0,800),1,1)}),n.fillStyle="#ebd694",n.fill(),r}("sf",ee),[{z:-r,b:"0000",t:e},{y:-r,rx:-90,b:"0000",t:e},{y:r,rx:90,b:"0000",t:e},{x:-r,ry:90,b:"0000",t:e},{x:r,ry:-90,b:"0000",t:e},{z:r,rx:180,b:"0000",t:e}].forEach((e,t)=>{S.plane({b:"000",...e,n:"skybox"+t,g:"skybox",size:2*r})}),S.longPyramid({n:"shipBase",g:"ship",size:.18,y:.18,b:"5796a1"}),S.ufo({n:"shipBody",g:"ship",y:-.06,rx:90,size:.39,b:"5796a1",s:1}),S.ufo({n:"sCockpit",g:"ship",y:-.06,rx:90,z:.12,size:.15,b:"666c",s:1}),e={n:"shipComp1",g:"ship",x:-.09,y:-.21,size:.12,b:"5796a1"},S.cube(e),S.cube({...e,n:"shipComp2",x:-e.x}),e={n:"shipEngine1",g:"ship",ry:45,rx:90,x:.33,y:-.09,size:.3,b:"8bc7bf"},S.longerRect(e),S.longerRect({...e,n:"shipEngine2",x:-.33}),e={n:"shipEngineBack1",g:"ship",x:.33,y:-.3,size:.3/3,b:"5796a1"},S.longPyramid(e),S.longPyramid({...e,n:"shipEngineBack2",x:-.33}),S.plank({n:"sWing1",g:"ship",rx:90,ry:90,x:-0,y:-.09,z:0,size:.03,b:"5796a1"}),e={g:"ship",n:"sFlame1",rx:180,x:.33,y:-.42,size:.078,b:"ebd69400"},S.longPyramid(e),S.longPyramid({...e,n:"sFlame2",x:-.33}),c(6,U);const i=2*Math.PI;return c(32,(e,t)=>{var r=0===e?0:i*e/t,{x:n,y:o}=(t=180/w*r,d(r,2e3)),r="r"+e;S.group({n:r,g:"ring"}),S.plank({n:"ring"+e,g:r,x:n,y:o,rz:t,size:20,b:"5796a1"}),S.cube({n:"ringBuilding"+e,g:r,x:n,y:o,rz:t,size:50,b:"478691"})}),c(300,e=>{S.billboard({n:"litter"+e,g:"system",x:M(4e3),y:M(4e3),z:M(4e3),size:1,b:"555e"})}),c(30,e=>{e={n:"crate"+e,passType:"crate",passthru:["crate"],g:"system",x:M(3e3),y:M(3e3),z:M(3e3),vel:{...new k(void 0,void 0,void 0)},size:3,r:2,b:"de8b6f",rx:h(0,359),ry:h(0,359),rz:h(0,359),hp:3},B.push(e),_[e.n]=e,S.cube(e)}),{ship:E,renderables:_,physicsEnts:B,klaxShips:re}}function i(e,{x:t=.5,y:r=.5,z:n=.5}={}){f.add(e,{vertices:[t,r,n,-t,r,n,-t,-r,n,t,r,n,-t,-r,n,t,-r,n,t,r,-n,t,r,n,t,-r,n,t,r,-n,t,-r,n,t,-r,-n,t,r,-n,-t,r,-n,-t,r,n,t,r,-n,-t,r,n,t,r,n,-t,r,n,-t,r,-n,-t,-r,-n,-t,r,n,-t,-r,-n,-t,-r,n,-t,r,-n,t,r,-n,t,-r,-n,-t,r,-n,t,-r,-n,-t,-r,-n,t,-r,n,-t,-r,n,-t,-r,-n,t,-r,n,-t,-r,-n,t,-r,-n],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]})}function Y(e,{x:t=.5,y:r=.5,z:n=.5}={}){f.add(e,{vertices:[-t,-r,n,t,-r,n,0,r,0,t,-r,n,t,-r,-n,0,r,0,t,-r,-n,-t,-r,-n,0,r,0,-t,-r,-n,-t,-r,n,0,r,0,t,-r,n,-t,-r,n,-t,-r,-n,t,-r,n,-t,-r,-n,t,-r,-n],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]})}function q(e,{x:t=2,y:r=2,z:n=2,precision:o=20,i,ai:s,j:a,aj:l,p1:c,p2:d,vertices:g=[],indices:h=[],uv:p=[]}={}){var{PI:m,sin:u,cos:y}=Math;for(a=0;a<=o;a++)for(l=a*m/o,i=0;i<=o;i++)g.push(+(u(s=2*i*m/o)*u(l)/t).toFixed(6),+(y(l)/r).toFixed(6),+(y(s)*u(l)/n).toFixed(6)),p.push(3.5*u(i/o),-u(a/o)),i<o&&a<o&&h.push(c=a*(o+1)+i,d=c+(o+1),c+1,c+1,d,d+1);f.add(e,{vertices:g,uv:p,indices:h})}function p(e){r[e].done||(r[e].done=1,V())}function V(){console.log(P),x.getElementById("goals").innerHTML=r.map(({t:e,done:t})=>`<li class="${t?"done":""}">${e}</li>`).join("")+`<li>Klaxonian Ships Destroyed: 0 / ${P.klaxShips.length}</li>`+"<li>Ring Repair Parts: 0 / 5</li>"}function e(){var e,t,r,n=x.getElementById("canvas");t=(e=n).clientWidth,(r=e.clientHeight)<t?(D.aspect=t/r,e.height=F(t,800),e.width=t/D.aspect):(e.width=e.height=F(t,800),D.aspect=1),y.setup({lockElt:n,keys:{Tab:()=>{p(0),y.toggleLock()}}}),A={tf:o(9,"#ebd694","tf",.3),plasma:o(11,"#de8b6f","plasma",.2),photon:o(13,"#b0455a","photon",.5),klaxPlasma:o(15,"#90d59c","klaxPlasma",.3)},n.addEventListener("click",()=>{y.lock()}),f.reset(n),f.clearColor("2a242b"),f.light({x:-1,y:-1.2,z:.2}),f.ambient(.8),i("plank",{y:10,z:5,x:.3}),i("longRect",{x:.2,y:.2}),i("longerRect",{x:.2,y:.2,z:.7}),i("cube"),Y("pyramid"),Y("longPyramid",{y:.8}),q("sphere"),q("ufo",{y:3,precision:10}),P=W(f,12500),["renderables","ship","physicsEnts","klaxShips"].forEach(e=>{window[e]=P[e],g[e]=P[e]}),V()}function X(e,t=0){var{x:t,y:r,z:n}=u(e).scale(t);e.thrust={x:t,y:r,z:n}}function $(e,t){e.damage&&t.hp&&(t.hp-=e.damage,t.hp<=0&&(t.decay=0),m.zzfx(t===ship?1.1:.5,void 0,416,.02,.21,.52,4,2.14,.2,void 0,void 0,void 0,void 0,1.7,void 0,.9,void 0,.44,.12,.23),t===ship)&&flashBorder("canvas"),e.aggro+=1,t.aggro+=1,e.shieldOpacity+=5,t.shieldOpacity+=5}function H(t){c(t.length,e=>{var r,n;r=t[e],n=t,r.collided||c(n.length,e=>{var t,s,a;e=n[e],r.passthru&&r.passthru.includes(e.passType)||e.passthru&&e.passthru.includes(r.passType)||r===e||e.collided||(t=new k(r,void 0,void 0).distance(e))<=r.r+e.r&&(a=e,e=t,$(((s=r).collided=a).collided=s,a),$(a,s),e=new k(a,void 0,void 0).sub(s).normalize().scale((s.r+a.r-e)/2),new k(s,void 0,void 0).sub(e).copyTo(s),new k(a,void 0,void 0).add(e).copyTo(a),["x","y","z"].forEach(e=>{var t=s.mass||1,r=a.mass||1,n=t+r,o=s.vel[e],i=a.vel[e];s.vel[e]=(t-r)/n*o+2*r/n*i,a.vel[e]=2*t/n*o+(r-t)/n*i}))})})}function K(t,r,n=.01){["rx","ry","rz"].forEach(e=>t[e]=j(n,t[e],r[e]))}function N(e,t,r,n){var{vScale:o,tScale:i,damage:s,size:a,sound:l}=se[e],c=A[e],{x:d,y:g,z:h}=t,p=u(t);t=p.scale(o).add(t.vel),m.zzfx(...l),e={n:e+r+String(Number(new Date)),g:"system",passType:r,x:d,y:g,z:h,vel:{...t},thrust:{...p.scale(i)},friction:0,decay:5,damage:s,r:5,passthru:n,mass:.01},physicsEnts.push(e),renderables[e.n]=e,f.billboard({...e,size:a,t:c})}function Z(){const o=T/1e3;var e,t,r,n,i=y["down"];i["]"]&&(D.targetFov+=.5),i["["]&&(D.targetFov-=.5),i.p||(t=i.Shift?2:1,e=0,i.s||i.S?(e=ship.thrustForce*t*-.5,i.w=!1,i.W=!1):(i.w||i.W)&&(e=ship.thrustForce*t),X(ship,e),r=0<e?"ebd694dd":"ebd69400",{rx:r,ry:e,rz:t}=(f.move({n:"sFlame1",b:r}),f.move({n:"sFlame2",b:r}),0===e?(f.delete("sIgnite1"),f.delete("sIgnite2")):(m.zzfx(1<t?.15:.1,void 0,794,.02,.3,.32,void 0,3.96,void 0,.7,void 0,void 0,.16,2.1,void 0,1<t?.2:.8,.1,.31,.27),p(1),r={g:"ship",y:-.393,rx:70,size:.2,t:A.tf},f.billboard({...r,n:"sIgnite1",x:-.33}),f.billboard({...r,n:"sIgnite2",x:.33})),r=y.getClick(),0===ship.fireCooldown&&(i[" "]||r&&r.locked)&&(p(2),N(r&&r.right?"photon":"plasma",ship,"plasma",["ship","plasma"]),ship.fireCooldown=.3),ship.fireCooldown=L(ship.fireCooldown-o,0),klaxShips.forEach(e=>{var t,r;e.decay<=0||e.hp<=0||((r=(t=new k(e,void 0,void 0)).distance(ship))>2*e.sight?e.aggro=L(0,e.aggro-=.1):r<=e.sight&&(e.aggro=L(1,e.aggro)),e.aggro&&(K(e,t=t.toWAngles(ship),.02),e.thrustCooldown?e.thrustCooldown=L(e.thrustCooldown-o,0):(X(e,e.thrustForce),e.thrustCooldown=h(.5,3)),e.fireCooldown?e.fireCooldown=L(e.fireCooldown-o,0):(N("klaxPlasma",e,"klaxPlasma",["klaxShip","klaxPlasma"]),e.fireCooldown=h(.3,3))))}),H(physicsEnts),physicsEnts.forEach(e=>{var r,n;e.collided=0,r=e,n=o,["x","y","z"].forEach(e=>{let t=r.thrust&&r.thrust[e]||0;0===t&&0!==r.friction&&(t=-r.vel[e]*oe),r.vel[e]=l(r.vel[e]+t/(r.mass||1)/n,-3e3,3e3),r.vel[e]<1e-4&&-1e-4<r.vel[e]&&(r.vel[e]=0),r[e]=l(r[e]+r.vel[e]*n,-12500,12500)})}),i=y.getLockMove(),O.ry-=i.x/10,O.rx=F(L(O.rx-i.y/10,-180),0),K(ship,O,.05),i=a(new k(0,I.back,I.up),O),D.fov=j(.1,D.fov,D.targetFov+(e?e<0?-2:1<t?10:1:0)),ne(D.fov-D.lastFov),D.lastFov=D.fov,f.camera({...i,...function(e,t){var{rx:e,ry:r,rz:n}=e;return{rx:e+=t.rx,ry:r+=t.ry,rz:n+=t.rz}}(I,O),a:1e3,...D}),ship),f.move({n:"ship",rx:r,ry:e,rz:t}),Object.keys(renderables).forEach(e=>{const t=renderables[e];"number"==typeof t.decay&&(t.decay-=o,t.decay<=0)&&(f.delete(t.n),delete renderables[e],-1!==(e=physicsEnts.findIndex(e=>e.n===t.n)))&&physicsEnts.splice(e,1)}),s+=T/90,ie+=T/100,n={...renderables,system:{x:-ship.x,y:-ship.y,z:-ship.z,a:T},innerSun:{rx:s,ry:ie},p1:{rz:.1*s},p2:{rz:.15*s},p3:{rz:.05*s},ring:{rz:.5*s}},Object.keys(n).forEach(e=>{f.move({n:e,...n[e]},0)}),r=(i=new k(ship.vel,void 0,void 0)).x>i.y&&i.x>i.z?"X":i.y>i.x&&i.y>i.z?"Y":"Z",i="<b>"+[`Velocity: ${C(i.length())} (${r}), Pitch: ${C(O.rx+90)}, Yaw: `+C(O.ry)%360,"Hull: "+ship.hp].join("</b><b>")+"</b>",x.getElementById("si").innerHTML=i)}let t,f={models:{},reset:e=>{f.canvas=e,f.objs=0,f.current={},f.next={},f.textures={},f.gl=e.getContext("webgl2"),f.gl.blendFunc(770,771),f.gl.activeTexture(33984),f.program=f.gl.createProgram(),f.gl.enable(2884),f.gl.shaderSource(t=f.gl.createShader(35633),"#version 300 es\n      precision highp float;                        // Set default float precision\n      in vec4 pos, col, uv, normal;                 // Vertex attributes: position, color, texture coordinates, normal (if any)\n      uniform mat4 pv, eye, m, im;                  // Uniform transformation matrices: projection * view, eye, model, inverse model\n      uniform vec4 bb;                              // If the current shape is a billboard: bb = [w, h, 1.0, 0.0]\n      out vec4 v_pos, v_col, v_uv, v_normal;        // Varyings sent to the fragment shader: position, color, texture coordinates, normal (if any)\n      void main() {                                 \n        gl_Position = pv * (                        // Set vertex position: p * v * v_pos\n          v_pos = bb.z > 0.                         // Set v_pos varying:\n          ? m[3] + eye * (pos * bb)                 // Billboards always face the camera:  p * v * distance + eye * (position * [w, h, 1.0, 0.0])\n          : m * pos                                 // Other objects rotate normally:      p * v * m * position\n        );                                          \n        v_col = col;                                // Set varyings \n        v_uv = uv;\n        v_normal = transpose(inverse(m)) * normal;  // recompute normals to match model thansformation\n      }"),f.gl.compileShader(t),f.gl.attachShader(f.program,t),console.log("vertex shader:",f.gl.getShaderInfoLog(t)||"OK"),f.gl.shaderSource(t=f.gl.createShader(35632),"#version 300 es\n      precision highp float;                  // Set default float precision\n      in vec4 v_pos, v_col, v_uv, v_normal;   // Varyings received from the vertex shader: position, color, texture coordinates, normal (if any)\n      uniform vec3 light;                     // Uniform: light direction, smooth normals enabled\n      uniform vec4 o;                         // options [smooth, shading enabled, ambient, mix]\n      uniform sampler2D sampler;              // Uniform: 2D texture\n      out vec4 c;                             // Output: final fragment color\n\n      // The code below displays colored / textured / shaded fragments\n      void main() {\n        c = mix(texture(sampler, v_uv.xy), v_col, o[3]);  // base color (mix of texture and rgba)\n        if(o[1] > 0.){                                    // if lighting/shading is enabled:\n          c = vec4(                                       // output = vec4(base color RGB * (directional shading + ambient light)), base color Alpha\n            c.rgb * (max(0., dot(light, -normalize(       // Directional shading: compute dot product of light direction and normal (0 if negative)\n              o[0] > 0.                                   // if smooth shading is enabled:\n              ? vec3(v_normal.xyz)                        // use smooth normals passed as varying\n              : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))   // else, compute flat normal by making a cross-product with the current fragment and its x/y neighbours\n            )))\n            + o[2]),                                      // add ambient light passed as uniform\n            c.a                                           // use base color's alpha\n          );\n        }\n      }"),f.gl.compileShader(t),f.gl.attachShader(f.program,t),console.log("fragment shader:",f.gl.getShaderInfoLog(t)||"OK"),f.gl.linkProgram(f.program),f.gl.useProgram(f.program),console.log("program:",f.gl.getProgramInfoLog(f.program)||"OK"),f.gl.clearColor(1,1,1,1),f.clearColor=e=>f.gl.clearColor(...f.col(e)),f.clearColor("fff"),f.gl.enable(2929),f.light({y:-1}),f.camera({fov:30}),setTimeout(f.draw,16)},setState:(e,t,r)=>{var n,o,i,s,a;(n=e).n||(n.n="o"+f.objs++),e.size&&(e.w=e.h=e.d=e.size),e.t&&e.t.width&&!f.textures[e.t.id]&&(r=f.gl.createTexture(),f.gl.pixelStorei(37441,!0),f.gl.bindTexture(3553,r),f.gl.pixelStorei(37440,1),f.gl.texImage2D(3553,0,6408,6408,5121,e.t),f.gl.generateMipmap(3553),f.textures[e.t.id]=r),e.fov&&({near:a=1,far:o=1e3,fov:i,aspect:s=canvas.width/canvas.height}=e,r=1/Math.tan(i*Math.PI/180),n=1/(a-o),f.projection=new DOMMatrix([r/s,0,0,0,0,r,0,0,0,0,(o+a)*n,-1,0,0,2*a*o*n,0])),e={type:t,...f.current[e.n]=f.next[e.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0},...e,f:0},null==(i=f.models[e.type])||!i.vertices||null!=(s=f.models)&&s[e.type].verticesBuffer||(f.gl.bindBuffer(34962,f.models[e.type].verticesBuffer=f.gl.createBuffer()),f.gl.bufferData(34962,new Float32Array(f.models[e.type].vertices),35044),!f.models[e.type].normals&&f.smooth&&f.smooth(e),f.models[e.type].normals&&(f.gl.bindBuffer(34962,f.models[e.type].normalsBuffer=f.gl.createBuffer()),f.gl.bufferData(34962,new Float32Array(f.models[e.type].normals.flat()),35044))),null!=(r=f.models[e.type])&&r.uv&&!f.models[e.type].uvBuffer&&(f.gl.bindBuffer(34962,f.models[e.type].uvBuffer=f.gl.createBuffer()),f.gl.bufferData(34962,new Float32Array(f.models[e.type].uv),35044)),null!=(a=f.models[e.type])&&a.indices&&!f.models[e.type].indicesBuffer&&(f.gl.bindBuffer(34963,f.models[e.type].indicesBuffer=f.gl.createBuffer()),f.gl.bufferData(34963,new Uint16Array(f.models[e.type].indices),35044)),e.t?e.t&&!e.mix&&(e.mix=0):e.mix=1,f.next[e.n]=e},draw:(e,t,r,n,o=[])=>{for(n in t=e-f.lastFrame,f.lastFrame=e,requestAnimationFrame(f.draw),f.next.camera.g&&f.render(f.next[f.next.camera.g],t,1),r=f.animation("camera"),null!=(e=f.next)&&null!=(e=e.camera)&&e.g&&r.preMultiplySelf(f.next[f.next.camera.g].M||f.next[f.next.camera.g].m),f.gl.uniformMatrix4fv(f.gl.getUniformLocation(f.program,"eye"),!1,r.toFloat32Array()),r.invertSelf(),r.preMultiplySelf(f.projection),f.gl.uniformMatrix4fv(f.gl.getUniformLocation(f.program,"pv"),!1,r.toFloat32Array()),f.gl.clear(16640),f.next)f.next[n].t||1!=f.col(f.next[n].b)[3]?o.push(f.next[n]):f.render(f.next[n],t);o.sort((e,t)=>f.dist(t)-f.dist(e)),f.gl.enable(3042);for(n of o)["plane","billboard"].includes(n.type)&&f.gl.depthMask(0),f.render(n,t),f.gl.depthMask(1);f.gl.disable(3042),f.gl.uniform3f(f.gl.getUniformLocation(f.program,"light"),f.lerp("light","x"),f.lerp("light","y"),f.lerp("light","z"))},render:(e,t,r=["camera","light","group"].includes(e.type),n)=>{e.t&&(f.gl.bindTexture(3553,f.textures[e.t.id]),f.gl.uniform1i(f.gl.getUniformLocation(f.program,"sampler"),0)),e.f<e.a&&(e.f+=t),e.f>e.a&&(e.f=e.a),f.next[e.n].m=f.animation(e.n),f.next[e.g]&&f.next[e.n].m.preMultiplySelf(f.next[e.g].M||f.next[e.g].m),f.gl.uniformMatrix4fv(f.gl.getUniformLocation(f.program,"m"),!1,(f.next[e.n].M||f.next[e.n].m).toFloat32Array()),f.gl.uniformMatrix4fv(f.gl.getUniformLocation(f.program,"im"),!1,new DOMMatrix(f.next[e.n].M||f.next[e.n].m).invertSelf().toFloat32Array()),r||(f.gl.bindBuffer(34962,f.models[e.type].verticesBuffer),f.gl.vertexAttribPointer(n=f.gl.getAttribLocation(f.program,"pos"),3,5126,!1,0,0),f.gl.enableVertexAttribArray(n),f.models[e.type].uvBuffer&&(f.gl.bindBuffer(34962,f.models[e.type].uvBuffer),f.gl.vertexAttribPointer(n=f.gl.getAttribLocation(f.program,"uv"),2,5126,!1,0,0),f.gl.enableVertexAttribArray(n)),(e.s||f.models[e.type].customNormals)&&f.models[e.type].normalsBuffer&&(f.gl.bindBuffer(34962,f.models[e.type].normalsBuffer),f.gl.vertexAttribPointer(n=f.gl.getAttribLocation(f.program,"normal"),3,5126,!1,0,0),f.gl.enableVertexAttribArray(n)),f.gl.uniform4f(f.gl.getUniformLocation(f.program,"o"),e.s,(3<e.mode||3<f.gl[e.mode])&&!e.ns?1:0,f.ambientLight||.2,e.mix),f.gl.uniform4f(f.gl.getUniformLocation(f.program,"bb"),e.w,e.h,"billboard"==e.type,0),f.models[e.type].indicesBuffer&&f.gl.bindBuffer(34963,f.models[e.type].indicesBuffer),f.gl.vertexAttrib4fv(f.gl.getAttribLocation(f.program,"col"),f.col(e.b)),f.models[e.type].indicesBuffer?f.gl.drawElements(+e.mode||f.gl[e.mode],f.models[e.type].indices.length,5123,0):f.gl.drawArrays(+e.mode||f.gl[e.mode],0,f.models[e.type].vertices.length/3))},lerp:(e,t)=>{var r;return null!=(r=f.next[e])&&r.a?f.current[e][t]+f.next[e].f/f.next[e].a*(f.next[e][t]-f.current[e][t]):f.next[e][t]},animation:(e,t=new DOMMatrix)=>f.next[e]?t.translateSelf(f.lerp(e,"x"),f.lerp(e,"y"),f.lerp(e,"z")).rotateSelf(f.lerp(e,"rx"),f.lerp(e,"ry"),f.lerp(e,"rz")).scaleSelf(f.lerp(e,"w"),f.lerp(e,"h"),f.lerp(e,"d")):t,dist:(e,t=f.next.camera)=>null!=e&&e.m&&null!=t&&t.m?(t.m.m41-e.m.m41)**2+(t.m.m42-e.m.m42)**2+(t.m.m43-e.m.m43)**2:0,ambient:e=>f.ambientLight=e,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(e=>("0x"+e)/(t.length<5?15:255)),1],add:(t,e)=>{(f.models[t]=e).normals&&(f.models[t].customNormals=1),f[t]=e=>f.setState(e,t)},group:e=>f.setState(e,"group"),move:(e,t)=>setTimeout(()=>{f.setState(e)},t||1),delete:(e,t)=>setTimeout(()=>{delete f.next[e]},t||1),camera:(e,t)=>setTimeout(()=>{f.setState(e,e.n="camera")},t||1),light:(e,t)=>t?setTimeout(()=>{f.setState(e,e.n="light")},t):f.setState(e,e.n="light"),smooth:(e,t={},r=[],n,o,i,s,a,l,c,d,g,h,p,m,u)=>{for(f.models[e.type].normals=[],i=0;i<f.models[e.type].vertices.length;i+=3)r.push(f.models[e.type].vertices.slice(i,i+3));for(o=(n=f.models[e.type].indices)?1:(n=r,0),i=0;i<2*n.length;i+=3){var y;s=i%n.length,a=r[d=o?f.models[e.type].indices[s]:s],l=r[g=o?f.models[e.type].indices[1+s]:1+s],c=r[h=o?f.models[e.type].indices[2+s]:2+s],m=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],u=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],p=s<i?[0,0,0]:[m[1]*u[2]-m[2]*u[1],m[2]*u[0]-m[0]*u[2],m[0]*u[1]-m[1]*u[0]],t[y=a[0]+"_"+a[1]+"_"+a[2]]||(t[y]=[0,0,0]),t[y=l[0]+"_"+l[1]+"_"+l[2]]||(t[y]=[0,0,0]),t[y=c[0]+"_"+c[1]+"_"+c[2]]||(t[y]=[0,0,0]),f.models[e.type].normals[d]=t[a[0]+"_"+a[1]+"_"+a[2]]=t[a[0]+"_"+a[1]+"_"+a[2]].map((e,t)=>e+p[t]),f.models[e.type].normals[g]=t[l[0]+"_"+l[1]+"_"+l[2]]=t[l[0]+"_"+l[1]+"_"+l[2]].map((e,t)=>e+p[t]),f.models[e.type].normals[h]=t[c[0]+"_"+c[1]+"_"+c[2]]=t[c[0]+"_"+c[1]+"_"+c[2]].map((e,t)=>e+p[t])}}};f.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),f.add("billboard",f.models.plane);const n=window.document;var y={lockMove:{x:0,y:0},move:{x:0,y:0},wheel:0,click:null,lockElt:null,down:{},isLocked:()=>!!n.pointerLockElement,async lock(){n.pointerLockElement||await this.lockElt.requestPointerLock()},async toggleLock(){n.pointerLockElement?await this.unlock():await this.lock()},async unlock(){await n.exitPointerLock()},getLockMove(){var e={...this.lockMove};return this.lockMove.x=0,this.lockMove.y=0,e},getWheel(){var e=this.wheel;return this.wheel=0,e},getClick(){var e=this.click;return this.click=null,e},setup(t={}){this.lockElt=t.lockElt,onmousemove=e=>{var t=this[n.pointerLockElement?"lockMove":"move"];t.x+=e.movementX,t.y+=e.movementY},onkeydown=e=>{this.down[e.key]=!0,!e.repeat&&t.keys&&t.keys[e.key]&&(t.keys[e.key](),e.preventDefault())},onkeyup=e=>{this.down[e.key]=!1},onwheel=e=>{this.wheel+=e.deltaY};oncontextmenu=onclick=e=>{var{clientX:e,clientY:t,button:r}=e;this.click={clientX:e,clientY:t,button:r,left:0===r,right:2===r,locked:!!n.pointerLockElement}}}};const x=document,{sin:v,cos:b,atan2:z,PI:w,sqrt:G}=Math;class k{constructor(e=0,t=0,r=0){"object"==typeof e&&(t=e.y,r=e.z,e=e.x),this.x=e,this.y=t,this.z=r}copy(){return new k(this.x,this.y,this.z)}copyTo(e){e.x=this.x,e.y=this.y,e.z=this.z}add(e){return new k(this.x+e.x,this.y+e.y,this.z+e.z)}sub(e){return new k(this.x-e.x,this.y-e.y,this.z-e.z)}length(){return this.lengthSquared()**.5}lengthSquared(){return this.x**2+this.y**2+this.z**2}distance(e){return this.distanceSquared(e)**.5}distanceSquared(e){return(this.x-e.x)**2+(this.y-e.y)**2+(this.z-e.z)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new k(0,e,0)}scale(e){return new k(this.x*e,this.y*e,this.z*e)}cross(e){var{x:t,y:r,z:n}=this;return new k(r*e.z-n*e.y,n*e.x-t*e.z,t*e.y-r*e.x)}rotate(e,t,r){return this.rotateX(e).rotateY(t).rotateZ(r)}rotateX(e=0){var t=this.x,r=this.y*b(e)-this.z*v(e);return e=this.y*v(e)+this.z*b(e),new k(t,r,e)}rotateY(e=0){var t=this.x*b(e)+this.z*v(e),r=this.y;return e=-this.x*v(e)+this.z*b(e),new k(t,r,e)}rotateZ(e=0){var t=this.x*b(e)-this.y*v(e);return e=this.x*v(e)+this.y*b(e),new k(t,e,this.z)}toAngles(e){let{x:t,y:r,z:n}=this;e&&(t=e.x-t,r=e.y-r,n=e.z-n),e=z(r,t);var o=z(-n,G(t*t+r*r)),i=0;return 0===t&&0===r||(i=G(t*t+r*r),i=z(n,i)),{roll:i,pitch:o,yaw:e}}toWAngles(e){var{roll:e,pitch:t,yaw:r}=this.toAngles(e);return{rx:180/w*e,ry:180/w*t,rz:180/w*r}}}const J=Math["PI"],Q=2*J;let S;const ee=new class{constructor(e){this.seed=e}rand(e=1,t=0){return this.seed^=this.seed<<13,this.seed^=this.seed>>>17,this.seed^=this.seed<<5,t+(e-t)*Math.abs(this.seed%1e9)/1e9}int(e,t=0){return Math.floor(this.rand(e,t))}sign(){return 2*this.randInt(2)-1}}(1234),M=(e=12500)=>ee.rand(-e,e),E={x:0,y:0,z:6250,rx:-90,ry:0,rz:0,vel:{x:0,y:0,z:0},thrust:{x:0,y:0,z:0},thrustForce:.1,fireCooldown:0,r:2,passType:"ship",passthru:["plasma"],shieldOpacity:0,sight:1500,aggro:0,thrustCooldown:0,hp:5,maxHp:5,facing:{x:0,y:1,z:0}},te={...structuredClone(E),thrustForce:.002,passType:"klaxShip",passthru:["klaxPlasma"],facing:{x:1,y:0,z:0}},re=[],B=[E],_={},{min:F,max:L,round:C,abs:ne}=Math;let P,A={};const oe=1/12e3;var ie=s=0;const T=1e3/60,I={back:-1.5,up:.6,rx:80,ry:0,rz:0},D={fov:30,targetFov:30,lastFov:30,aspect:1,near:.5,far:25e3},O={rx:-90,ry:0,rz:0},r=["Check steering: [Tab] to toggle mouse-lock","Thrusters: [W]","Fire weapons: [Space] or [Click]"].map(e=>({t:e,done:0})),se={plasma:{vScale:25,tScale:5e-4,damage:1,size:1,sound:[,.1,295,.02,.01,.08,,1.72,-3.5,.2,,,,.2,,,.08,.62,.09]},photon:{vScale:15,tScale:1e-4,damage:3,size:1,sound:[2.06,.35,212,.05,.08,.01,,1.66,-4.8,.2,50,,,1.7,,.5,.28,.65,.02]},klaxPlasma:{vScale:25,tScale:5e-4,damage:1,size:10,sound:[.3,.4,241,.04,.03,.08,,.46,-7.7,,,,,,,.2,,.53,.05,.2]}};addEventListener("DOMContentLoaded",()=>{e(),setInterval(Z,T)}),window.g={input:y}}(zzfx);