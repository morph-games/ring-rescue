!function(){function h(t,r){for(let e=0;e<t;e+=1)r(e,t)}function c(e,t){return{x:t*Math.cos(e),y:t*Math.sin(e)}}function K(){return String(Number(new Date))+j(999)}function O(e,t){return e.rotate(l/180*t.rx,l/180*t.ry,l/180*t.rz)}function U(e){var t=e["facing"];return O(new E(t,void 0,void 0),e)}function g(e,t=0,r=1){return e<t?t:r<e?r:e}function m(e,t,r){return t+g(e)*(r-t)}function u(e=1,t=0){return t+Math.random()*(e-t)}function j(e,t=0){return Math.floor(u(e,t))}function y(e,t){var r=S.getElementById(e),o=r||S.createElement("canvas");return o.id=e,o.width=o.height=t,r||S.getElementById("loaded").appendChild(o),[o,o.getContext("2d"),t/2]}function a(e=4,t="#f00",r,o=.4,n=600){const[i,s,a]=y(r,n),l=(s.clearRect(0,0,n,n),[]),d=se/e,p=(e,t)=>{var{x:e,y:t}=c(e,t);l.push([a+e,a+t])};return h(e,e=>{p(d*e,a),p(d*e+d/2,a*o)}),f(s,l,t),i}function f(t,e,r,o){t.beginPath(),"function"==typeof e?e():(t.moveTo(...e[0]),e.forEach(e=>t.lineTo(...e))),r&&(t.fillStyle=r,t.fill()),o&&(t.strokeStyle=o[0],t.lineWidth=o[1],t.stroke()),t.closePath()}function W(e){const[t,a]=y("rabbit"+e,600);a.beginPath(),a.moveTo(10,600);var r=[[10,600],[50,550],[100,520],[270,480],[270,450]];return r.forEach(e=>a.lineTo(...e)),r.reverse().forEach(([e,t])=>a.lineTo(600-e,t)),a.fillStyle="#5796a1",a.fill(),a.closePath(),r=(e,t,r,o,n=0,i="#eee",s)=>{f(a,()=>{a.ellipse(e,t,r,o,n,0,se)},i,s)},e&&r(300,400,100,160,0,"#8bc7bf"),r(300,300,200,70),r(300,350,250,100),r(300,410,200,60),r(150,200,200,40,.4*d),r(450,200,200,40,.4*-d),e&&(r(430,320,20,30,0,"#445"),r(170,320,20,30,0,"#445"),r(440,290,16,40,-1.4*d,"#ccc"),r(160,290,16,40,1.4*d,"#ccc"),r(300,350,20,10,0,"#de8b6f"),f(a,[[300,450],[150,400],[450,400]],"#222")),r(300,320,290,180,0,"#ffffff55",["#8bc7bf",10]),t}function H(e,t){var[r,o]=y("hopArmor"+e+t,50);return f(o,[[0,0],[0,50],[50,50],[50,0],[0,0]],e,[t,6]),f(o,[[10,0],[10,10],[40,10],[40,0]],null,[t,2]),f(o,[[0,30],[20,30],[20,40],[50,40]],null,[t,2]),r}function q(e){const r="k"+e;var t={x:P(2e3),y:P(2e3),z:P(2e3)};e={n:r,...structuredClone(pe),...t,size:5,r:10,isGroup:1},p.group({n:r,g:"system",...t});const o={g:r,size:2.5,x:-1.5,b:"372b4e"},n={g:r,size:2,b:"471b6e"};p.cube({...o,n:r+"c",rx:45,b:"471b6e"}),h(4,e=>{p.cube({...o,n:r+"cc"+e,x:-2-e,size:2.5-.5*e})}),p.pyramid({n:r+"nose",rz:-90,g:r,size:1.5,b:"90d59c"}),(t=(e,t)=>p.longRect({...n,n:r+"wing"+e,...t}))(1,{y:2,rx:90,ry:45,rz:-45}),t(2,{y:2,x:1.5,rx:90,ry:45,rz:45,b:"471b6e"}),t(3,{y:-2,rx:90,ry:45,rz:45}),t(4,{y:-2,x:1.5,rx:90,ry:45,rz:-45,b:"471b6e"}),p.simpleSphere({n:r+"shield",g:r,size:10,b:"ebd69404"}),B[e.n]=e}function Y(e,r,t){p=e;const o=(e,t)=>{e={n:e,rx:0,ry:0,rz:0},t&&(e.g=t),p.group(e)};o("system"),"sun ring p1 p2 p3 a1 a2 a3".split(" ").forEach(e=>o(e,"system")),["ship","skybox"].forEach(e=>p.group({n:e})),e={shape:"simpleSphere",b:"775b5b"},[{shape:"sphere",n:"outerSun",g:"sun",size:500,b:"#de8b6f88"},{shape:"sphere",n:"innerSun",g:"sun",size:480,b:"#de8b6f"},{shape:"billboard",n:"sunFlare",g:"sun",size:640,b:"#de8b6f",t:a(16,"#de8b6f88","sun",.7)},{shape:"sphere",n:"planet1",g:"p1",...c(.5,3e3),size:200,b:"775b5b",s:1},{shape:"sphere",n:"planet2",g:"p2",...c(.7,4e3),size:120,b:"#b0455a",s:1},{shape:"sphere",n:"planet3",g:"p3",...c(2,7e3),size:80,b:"775b5b",s:1},{...e,n:"asteroid1",g:"a1",...c(3,1e3),size:30},{...e,n:"asteroid2",g:"a2",...c(3.5,2e3/1.7),size:35},{...e,n:"asteroid3",g:"a3",...c(5,2e3/1.8),size:40}].forEach(e=>{p[e.shape](e),B[e.n]=e}),e=function(e,t){const[r,o]=y(e,800);return h(1400,()=>{o.rect(t.int(0,800),t.int(0,800),1,1)}),o.fillStyle="#ebd694",o.fill(),r}("sf",le),[{z:-r,b:"0000",t:e},{y:-r,rx:-90,b:"0000",t:e},{y:r,rx:90,b:"0000",t:e},{x:-r,ry:90,b:"0000",t:e},{x:r,ry:-90,b:"0000",t:e},{z:r,rx:180,b:"0000",t:e}].forEach((e,t)=>{p.plane({b:"000",...e,n:"skybox"+t,g:"skybox",size:2*r})});var n=H("#8bc7bf","#7bb7af"),i=(e=H("#5796a1","#478691"),p.longPyramid({n:"shipBase",g:"ship",size:.18,y:.18,b:"#5796a1",t:e}),p.ufo({n:"shipBody",g:"ship",y:-.06,rx:90,size:.39,b:"#5796a1",s:1}),p.ufo({n:"sCockpit",g:"ship",y:-.06,rx:90,z:.12,size:.15,b:"666c",s:1}),{n:"shipComp1",g:"ship",x:-.09,y:-.21,ry:0,rz:-90,size:.12,b:"#5796a1",t:e});p.cube(i),p.cube({...i,n:"shipComp2",rz:90,x:-i.x}),n={n:"shipEngine1",g:"ship",ry:45,rx:90,x:.33,y:-.09,size:.3,b:"#8bc7bf",t:n},p.longerRect(n),p.longerRect({...n,n:"shipEngine2",rz:180,x:-.33}),n={n:"shipEngineBack1",g:"ship",x:.33,y:-.3,size:.3/3,b:"#5796a1"},p.longPyramid(n),p.longPyramid({...n,n:"shipEngineBack2",x:-.33}),p.plank({n:"sWing1",g:"ship",rx:90,ry:90,x:-0,y:-.09,z:0,size:.03,b:"#5796a1",t:e}),e={g:"ship",n:"sFlame1",rx:180,x:.33,y:-.42,size:.078,b:"ebd69400"},p.longPyramid(e),p.longPyramid({...e,n:"sFlame2",x:-.33}),t={g:"ship",y:-.393,rx:70,size:.2,t:t.tf},p.billboard({...t,n:"sIgnite1",x:-.33}),p.billboard({...t,n:"sIgnite2",x:.33}),p.simpleSphere({n:"sShield",g:"ship",size:.01,b:"de8b6f00",mode:2}),h(6,q);const s=2*Math.PI;return h(32,(e,t)=>{var r=0===e?0:s*e/t,{x:o,y:n}=(t=180/l*r,c(r,2e3)),r="r"+e;p.group({n:r,g:"ring"}),p.plank({n:"ring"+e,g:r,x:o,y:n,rz:t,size:20,b:"#5796a1"}),p.cube({n:"ringB"+e,g:r,x:o,y:n,rz:t,size:50,b:"478691"})}),h(14,e=>{var t=(t="de8b6f 471b6e 524bb3 5796a1 464040 775b5b".split(" "))[j(0,t.length)];e={n:"crate"+e,passType:"crate",passthru:["crate"],g:"system",...{x:P(3e3),y:P(3e3),z:P(3e3)},vel:{...new E(void 0,void 0,void 0)},size:20,r:20,b:t,rx:u(0,359),ry:u(0,359),rz:u(0,359),hp:3,drops:["parts"],explodes:{colors:["464040",t],size:2,count:10},p:1},B[e.n]=e,p.cube(e)}),{ship:de,renderables:B}}function n(e,{x:t=.5,y:r=.5,z:o=.5}={}){w.add(e,{vertices:[t,r,o,-t,r,o,-t,-r,o,t,r,o,-t,-r,o,t,-r,o,t,r,-o,t,r,o,t,-r,o,t,r,-o,t,-r,o,t,-r,-o,t,r,-o,-t,r,-o,-t,r,o,t,r,-o,-t,r,o,t,r,o,-t,r,o,-t,r,-o,-t,-r,-o,-t,r,o,-t,-r,-o,-t,-r,o,-t,r,-o,t,r,-o,t,-r,-o,-t,r,-o,t,-r,-o,-t,-r,-o,t,-r,o,-t,-r,o,-t,-r,-o,t,-r,o,-t,-r,-o,t,-r,-o],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]})}function $(e,{x:t=.5,y:r=.5,z:o=.5}={}){w.add(e,{vertices:[-t,-r,o,t,-r,o,0,r,0,t,-r,o,t,-r,-o,0,r,0,t,-r,-o,-t,-r,-o,0,r,0,-t,-r,-o,-t,-r,o,0,r,0,t,-r,o,-t,-r,o,-t,-r,-o,t,-r,o,-t,-r,-o,t,-r,-o],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]})}function X(e,{x:t=2,y:r=2,z:o=2,precision:n=20,i,ai:s,j:a,aj:l,p1:d,p2:p,vertices:c=[],indices:h=[],uv:g=[]}={}){var{PI:m,sin:u,cos:y}=Math;for(a=0;a<=n;a++)for(l=a*m/n,i=0;i<=n;i++)c.push(+(u(s=2*i*m/n)*u(l)/t).toFixed(6),+(y(l)/r).toFixed(6),+(y(s)*u(l)/o).toFixed(6)),g.push(3.5*u(i/n),-u(a/n)),i<n&&a<n&&h.push(d=a*(n+1)+i,p=d+(n+1),d+1,d+1,p,p+1);w.add(e,{vertices:c,uv:g,indices:h})}function v(...e){ce.play(...e)}function x(e){if(void 0!==e){if(R[e].done)return;R[e].done=1}var r;e=_.ogKlaxShipCount-_.klaxShipLeft,_.klaxShipLeft<=0&&(R[6].done=1),7<=(ship.inv.parts||0)&&(R[7].done=1),r=e,e=R.map(({t:e,done:t})=>`<li class="${t?"done":""}">${e.replace("{K}",r).replace("{S}",_.ogKlaxShipCount).replace("{P}",ship.inv.parts||0).replace("{M}",7)}</li>`).join(""),S.getElementById("goals").innerHTML=e,R.length===R.filter(e=>e.done).length&&N("You did it! With those parts we should be able to get the Ring powered up again.<p>Thank you!</p><p>(Refresh page to play again.)")}function N(e){v(2.36,0,130.8128,.02,.51,.2,void 0,1.91,void 0,void 0,void 0,void 0,.08,void 0,void 0,void 0,.04,.5,void 0,.39),_.paused=1;const t=S.getElementById("dialog").classList,r=S.getElementById("goals").style;return r.opacity="0",k.unlock(),re("pic",`<img src="${F.rabbit.toDataURL()}" />`),re("txt",e+'<i data-key="Enter">Close [Enter]</i>'),t.add("show"),w.camera({x:0,y:100,z:0,a:200},500),w.move({n:"system",x:1e3,y:-500,z:-2500,a:2e3},500),_.nextEnter=()=>{v(.5,void 0,259,.02,.02,.01,2,.19,void 0,void 0,-48,.01,void 0,void 0,3.4,.8,void 0,.13,.01),r.opacity="1",t.remove("show"),_.paused=0,S.querySelector("main").classList.remove("ui--off")}}function e(){var e,t,r,o=S.getElementById("canvas");t=(e=o).clientWidth,(r=e.clientHeight)<t?(I.aspect=t/r,e.height=C(t,800),e.width=t/I.aspect):(e.width=e.height=C(t,800),I.aspect=1),k.setup({lockElt:o,keys:{Tab:()=>{x(0),k.toggleLock()},p:()=>{_.paused=!_.paused},t:()=>{_.trail=!_.trail},Enter:()=>{_.nextEnter&&(_.nextEnter=_.nextEnter())}}}),F={tf:a(9,"#ebd694","tf",.3),plasma:a(11,"#de8b6f","plasma",.2),photon:a(13,"#b0455a","photon",.5),klaxPlasma:a(15,"#90d59c","klaxPlasma",.3),rabbit:W(1),pilot:W(0),scan:a(8,"#90d59c","scan",1)},o.addEventListener("click",()=>{k.lock()}),w.reset(o),w.clearColor("2a242b"),w.light({x:-1,y:-1.2,z:.2}),w.ambient(.8),n("plank",{y:10,z:5,x:.3}),n("longRect",{x:.2,y:.2}),n("longerRect",{x:.2,y:.2,z:.7}),n("cube"),$("pyramid"),$("longPyramid",{y:.8}),X("sphere"),X("simpleSphere",{precision:6}),X("ufo",{y:3,precision:10}),ue=Y(w,15e3,F),["renderables","ship"].forEach(e=>{window[e]=ue[e],_[e]=ue[e]}),(o=Object.entries(renderables).filter(([,e])=>e.isKlax)).forEach(([,e],t)=>{e.isKlax&&(e={n:t="scan"+t,g:"system",x:e.x,y:e.y,z:e.z,size:120,t:F.scan},renderables[t]=e,w.billboard(e))}),_.ogKlaxShipCount=_.klaxShipLeft=o.length,x()}function V(e,t=0){var{x:t,y:r,z:o}=U(e).scale(t);e.thrust={x:t,y:r,z:o}}function Z(t){return 0<["x","y","z"].filter(e=>15e3<=t[e]||t[e]<=-15e3).length}function G(e,t){var r,o,n;e.damage&&t.hp&&(o=t===ship,r=g((t.shields||0)/100,0,1),t.hp-=e.damage*(1-r),e.destroyOnDamage&&(e.decay=0),t.hp<=0?(t.decay=0,t.drops&&t.drops.forEach(e=>ship.inv[e]=(ship.inv[e]||0)+1),t.explodes&&b(t,t.explodes)):b({x:t.x,y:t.y,z:t.z},{count:8}),v(o?1.5:.7,void 0,416,.02,.21,.52,4,2.14,.2,void 0,void 0,void 0,void 0,1.7,void 0,.9,void 0,.44,.12,.23),o)&&(r="canvas",o="#b0455a",n=1500,new Animation(new KeyframeEffect(S.getElementById(r),[{borderColor:o},{borderColor:"#000"}],{duration:n,direction:"alternate",easing:"linear"}),S.timeline).play()),e.aggro+=1,t.aggro+=1}function J(r,o){r.collided||1!==r.p||h(o.length,e=>{var t,s,a;e=o[e],1!==r.p||1!==e.p||r.passthru&&r.passthru.includes(e.passType)||1!==e.p||1!==r.p||e.passthru&&e.passthru.includes(r.passType)||r===e||e.collided||(t=new E(r,void 0,void 0).distance(e))<=r.r+e.r&&(a=e,e=t,G(((s=r).collided=a).collided=s,a),G(a,s),e=new E(a,void 0,void 0).sub(s).normalize().scale((s.r+a.r-e)/2),new E(s,void 0,void 0).sub(e).copyTo(s),new E(a,void 0,void 0).add(e).copyTo(a),["x","y","z"].forEach(e=>{var t=s.mass||1,r=a.mass||1,o=t+r,n=s.vel[e],i=a.vel[e];s.vel[e]=(t-r)/o*n+2*r/o*i,a.vel[e]=2*t/o*n+(r-t)/o*i}))})}function Q(t,r,e=0){const{steerPercent:o=.01}=t;["rx","ry","rz"].forEach(e=>t[e]=m(o,t[e],r[e])),e&&(t.ry=m(.1,t.ry,r.ry+e))}function ee(e,t,r,o){var{vScale:n,tScale:i,damage:s,size:a,sound:l}=ye[e],d=F[e],p=U(t),{x:c,y:h,z:g}=new E(t,void 0,void 0).add(p.normalize(t.size));t=p.scale(n).add(t.vel),v(...l),e={n:e+r+K(),g:"system",passType:r,x:c,y:h,z:g,vel:{...t},thrust:{...p.scale(i)},decay:5,damage:s,r:5,passthru:o,mass:.01,size:a,destroyOnDamage:1,p:1},renderables[e.n]=e,w.billboard({...e,t:d})}function b(r,e){let{x:o,y:n,z:i}=r;const{count:t=20,size:s=2,colors:a=["464040","de8b6f","b0455a"],maxDecay:l=10}=e||r.explodes||{};h(t,()=>{const t=oe(r.vel||{x:0,y:0,z:0});["x","y","z"].forEach(e=>{t[e]+=u(-20,20)});var e={n:"explosion"+K(),x:o+u(-.5,.5),y:n+u(-.5,.5),z:i+u(-.5,.5),vel:t,decay:u(1,l),r:1,g:"system",size:L(s+u(-s/2,s/2),.2),passType:"dust",passthru:["dust"],mass:.01,b:a[j(0,a.length)],destroyOnDamage:1,p:2};renderables[e.n]=e,w.billboard({...e})})}function z(e,t){let r="";return h(Math.floor(e/t*10),()=>r+="-"),r}function te(){v(.5,void 0,144,.01,.04,.17,1,.77,void 0,void 0,-119,.09,void 0,void 0,31,.1,void 0,.84,.03,.06)}function r(){var i,n,e,t,r,o,s,a,l,d,p,c;_.paused||(_.tick++,1e5<_.tick&&(_.tick=0),i=A/1e3,n=k["down"],n["]"]&&(I.targetFov+=.5),n["["]&&(I.targetFov-=.5),t=k.getWheel(),(n["-"]||0<t)&&(T.zoom=g(T.zoom+.1,0,100)),(n["="]||n["+"]||t<0)&&(T.zoom=g(T.zoom+-.1,0,100)),n.p)||(e=n.a?90:n.d?-90:0,r=0,1<(t=n.Shift?2:1)&&x(4),ship.power<=0||(n.s?(r=ship.thrustForce*t*-.5,n.w=0):n.w&&(r=ship.thrustForce*t)),V(ship,r),l=0<r?"ebd694dd":"ebd69400",w.move({n:"sFlame1",b:l}),w.move({n:"sFlame2",b:l}),ship.ignition=m(.2,ship.ignition,r?ship.ignitionSize:1e-4),w.move({n:"sIgnite1",size:ship.ignition,y:.3*(r<0?.6:-1.31)}),w.move({n:"sIgnite2",size:ship.ignition,y:.3*(r<0?.6:-1.31)}),r&&(ship.power-=ship.enginePowerUsage,v(1<t?.15:.1,void 0,794,.02,.3,.32,void 0,3.96,void 0,.7,void 0,void 0,.16,2.1,void 0,1<t?.2:.8,.1,.31,.27),x(2)),l=k.getClick(),0===ship.fireCooldown&&(n.f||n.r||l&&l.locked)&&(x(3),ship.power<ship.weaponPowerUsage?te():(ship.power-=ship.weaponPowerUsage,ee(l&&l.right||n.r?"photon":"plasma",ship,"plasma",["ship","plasma","klaxPlasma"]),ship.fireCooldown=.3)),n[" "]&&(12<ship.power?(l=C(ship.power,ship.shieldPower-ship.shields),ship.shields+=l,ship.power-=l,v(.4,void 0,99,void 0,.23,.12,3,1.07,void 0,5,void 0,void 0,.06,void 0,void 0,1,void 0,.7,.24,.32),x(5)):te()),n.y&&b(ship,ship.explodes),n.c&&x(1),o=[ship],s=[],Object.entries(renderables).forEach(([,e])=>{e.p&&o.push(e),e.isKlax&&s.push(e)}),_.klaxShipLeft=s.length,s.forEach((e,t)=>{var r,o;e.decay<=0||e.hp<=0||((o=(r=new E(e,void 0,void 0)).distance(ship))>2*e.sight?e.aggro=L(0,e.aggro-=.1):o<=e.sight&&(e.aggro=L(1,e.aggro)),e.aggro&&(Q(e,r=r.toWAngles(ship)),e.thrustCooldown?e.thrustCooldown=L(e.thrustCooldown-i,0):(V(e,e.thrustForce),e.thrustCooldown=u(.5,1)),e.fireCooldown?e.fireCooldown=L(e.fireCooldown-i,0):(ee("klaxPlasma",e,"klaxPlasma",["klaxShip","klaxPlasma","plasma"]),e.fireCooldown=u(.3,3)))),renderables["scan"+t]={...renderables["scan"+t],...n.c&&0<e.hp?{x:e.x,y:e.y,z:e.z,size:110,b:"90d59c"}:{size:.1,b:"0000"}}}),h(o.length,e=>J(o[e],o)),o.forEach(e=>{e.collided=0;var t=e,r=i,{friction:e=1}=t,o=(e*=.25,Z(t)&&(e*=10),new E(t.vel,void 0,void 0)),n=new E(t.thrust||void 0,void 0,void 0).scale(1/(t.mass||1));t.vel=o.sub(o.normalize(e)).add(n.scale(1/r)),800<(e=t.vel.length())?t.vel=t.vel.normalize(800):e<1e-4&&(t.vel=new E(void 0,void 0,void 0)),["x","y","z"].forEach(e=>{t[e]=g(t[e]+t.vel[e]*r,-15e3,15e3),Z(t)&&t.decay&&(t.decay=0)})}),ship.fireCooldown=L(ship.fireCooldown-i,0),ship.power=C(ship.maxPower,ship.power+ship.recharge),ship.shields=L(0,ship.shields-ship.shieldsDecayAmount),ship.hp<=0&&(ship.size=.01,b(ship),(async()=>{await ae(1500),_.paused=1,k.unlock(),S.querySelector("main").classList.add("end"),S.getElementById("end").style.display="flex"})()),l=k.getLockMove(),D.ry-=l.x/10,D.rx=C(L(D.rx-l.y/10,-180),0),Q(ship,D,e),e=O(new E(0,T.back,T.up).scale(T.zoom),D),I.fov=m(.1,I.fov,I.targetFov+(r?r<0?-2:1<t?10:1:0)),t=.001<ge(I.fov-I.lastFov),I.lastFov=I.fov,r={...e,...function(e,t){var{rx:e,ry:r,rz:o}=e;return{rx:e+=t.rx,ry:r+=t.ry,rz:o+=t.rz}}(T,D),a:A},t&&(r={...r,...I}),w.camera(r),_.trail&&(l=ship,d=i,l.trailCooldown?l.trailCooldown=L(l.trailCooldown-d,0):(ship.trailCooldown=.1,0!==new E(l.vel,void 0,void 0).length()&&({x:d,y:p,z:c}=l,l={n:l.n+"trail"+K(),x:d,y:p,z:c,decay:10,g:"system",size:u(.1,.3),b:"7666"},renderables[l.n]=l,w.billboard({...l})))),Object.keys(renderables).forEach(e=>{var t=renderables[e];"number"==typeof t.decay&&(t.decay-=i,t.decay<=0)&&(t.isGroup?w.move({n:t.n,x:6e4}):w.delete(t.n),delete renderables[e],x())}),t=g(ship.shields,10,99),w.move({n:"sShield",b:"de8b6f"+t,size:ship.shields?1.2:.01,a:100}),t={...ship,x:0,y:0,z:0},r={...renderables},e={x:-ship.x,y:-ship.y,z:-ship.z,a:A},M+=A/90,a={ship:t,...r,system:e,innerSun:{rx:M,ry:.9*M},p1:{rz:.1*M},p2:{rz:.15*M},p3:{rz:.05*M},ring:{rz:.5*M},a1:{rz:.7*M},a2:{rz:.6*M},a3:{rz:.5*M}},Object.keys(a).forEach(e=>{w.move({n:e,...a[e],a:A},0)}),0==_.tick%4&&(p=(d=new E(ship.vel,void 0,void 0)).x>d.y&&d.x>d.z?"X":d.y>d.x&&d.y>d.z?"Y":"Z",d=d.length(),p=(_.paused?"<b>Paused</b>":"")+"<b>"+[`Velocity: ${he(d)} (${p}) `+z(d,800),`Power: ${me(ship.power)} `+z(ship.power,ship.maxPower),`Shields: ${me(ship.shields)} `+z(ship.shields,100),`Hull: ${me(10*ship.hp)/10} `+z(ship.hp,ship.maxHp)].join("</b><b>")+"</b>",S.getElementById("si").innerHTML=p))}let t,w={models:{},reset:e=>{w.canvas=e,w.objs=0,w.current={},w.next={},w.textures={},w.gl=e.getContext("webgl2"),w.gl.blendFunc(770,771),w.gl.activeTexture(33984),w.program=w.gl.createProgram(),w.gl.enable(2884),w.gl.shaderSource(t=w.gl.createShader(35633),"#version 300 es\n      precision highp float;\n      in vec4 pos, col, uv, normal;\n      uniform mat4 pv, eye, m, im;\n      uniform vec4 bb;\n      out vec4 v_pos, v_col, v_uv, v_normal;\n      void main() {\n        gl_Position = pv * (v_pos = bb.z > 0. ? m[3] + eye * (pos * bb) : m * pos);                                          \n        v_col = col;\n        v_uv = uv;\n        v_normal = transpose(inverse(m)) * normal;\n      }"),w.gl.compileShader(t),w.gl.attachShader(w.program,t),console.log("vertex shader:",w.gl.getShaderInfoLog(t)||"OK"),w.gl.shaderSource(t=w.gl.createShader(35632),"#version 300 es\n      precision highp float;\n      in vec4 v_pos, v_col, v_uv, v_normal;\n      uniform vec3 light;\n      uniform vec4 o;\n      uniform sampler2D sampler;\n      out vec4 c;\n      void main() {\n        c = mix(texture(sampler, v_uv.xy), v_col, o[3]);\n        if(o[1] > 0.){\n          c = vec4(c.rgb * (max(0., dot(light, -normalize(o[0] > 0. ? vec3(v_normal.xyz) : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz)))))\n            + o[2]),\n            c.a\n          );\n        }\n      }"),w.gl.compileShader(t),w.gl.attachShader(w.program,t),console.log("fragment shader:",w.gl.getShaderInfoLog(t)||"OK"),w.gl.linkProgram(w.program),w.gl.useProgram(w.program),console.log("program:",w.gl.getProgramInfoLog(w.program)||"OK"),w.gl.clearColor(1,1,1,1),w.clearColor=e=>w.gl.clearColor(...w.col(e)),w.clearColor("fff"),w.gl.enable(2929),w.light({y:-1}),w.camera({fov:30}),setTimeout(w.draw,16)},setState:(e,t,r)=>{var o,n,i,s,a;(o=e).n||(o.n="o"+w.objs++),e.size&&(e.w=e.h=e.d=e.size),e.t&&e.t.width&&!w.textures[e.t.id]&&(r=w.gl.createTexture(),w.gl.pixelStorei(37441,!0),w.gl.bindTexture(3553,r),w.gl.pixelStorei(37440,1),w.gl.texImage2D(3553,0,6408,6408,5121,e.t),w.gl.generateMipmap(3553),w.textures[e.t.id]=r),e.fov&&({near:a=1,far:n=1e3,fov:i,aspect:s=canvas.width/canvas.height}=e,r=1/Math.tan(i*Math.PI/180),o=1/(a-n),w.projection=new DOMMatrix([r/s,0,0,0,0,r,0,0,0,0,(n+a)*o,-1,0,0,2*a*n*o,0])),e={type:t,...w.current[e.n]=w.next[e.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0},...e,f:0},null==(i=w.models[e.type])||!i.vertices||null!=(s=w.models)&&s[e.type].verticesBuffer||(w.gl.bindBuffer(34962,w.models[e.type].verticesBuffer=w.gl.createBuffer()),w.gl.bufferData(34962,new Float32Array(w.models[e.type].vertices),35044),!w.models[e.type].normals&&w.smooth&&w.smooth(e),w.models[e.type].normals&&(w.gl.bindBuffer(34962,w.models[e.type].normalsBuffer=w.gl.createBuffer()),w.gl.bufferData(34962,new Float32Array(w.models[e.type].normals.flat()),35044))),null!=(r=w.models[e.type])&&r.uv&&!w.models[e.type].uvBuffer&&(w.gl.bindBuffer(34962,w.models[e.type].uvBuffer=w.gl.createBuffer()),w.gl.bufferData(34962,new Float32Array(w.models[e.type].uv),35044)),null!=(a=w.models[e.type])&&a.indices&&!w.models[e.type].indicesBuffer&&(w.gl.bindBuffer(34963,w.models[e.type].indicesBuffer=w.gl.createBuffer()),w.gl.bufferData(34963,new Uint16Array(w.models[e.type].indices),35044)),e.t?e.t&&!e.mix&&(e.mix=0):e.mix=1,w.next[e.n]=e},draw:(e,t,r,o,n=[])=>{for(o in t=e-w.lastFrame,w.lastFrame=e,requestAnimationFrame(w.draw),w.next.camera.g&&w.render(w.next[w.next.camera.g],t,1),r=w.animation("camera"),null!=(e=w.next)&&null!=(e=e.camera)&&e.g&&r.preMultiplySelf(w.next[w.next.camera.g].M||w.next[w.next.camera.g].m),w.gl.uniformMatrix4fv(w.gl.getUniformLocation(w.program,"eye"),!1,r.toFloat32Array()),r.invertSelf(),r.preMultiplySelf(w.projection),w.gl.uniformMatrix4fv(w.gl.getUniformLocation(w.program,"pv"),!1,r.toFloat32Array()),w.gl.clear(16640),w.next)w.next[o].t||1!=w.col(w.next[o].b)[3]?n.push(w.next[o]):w.render(w.next[o],t);n.sort((e,t)=>w.dist(t)-w.dist(e)),w.gl.enable(3042);for(o of n)["plane","billboard"].includes(o.type)&&w.gl.depthMask(0),w.render(o,t),w.gl.depthMask(1);w.gl.disable(3042),w.gl.uniform3f(w.gl.getUniformLocation(w.program,"light"),w.lerp("light","x"),w.lerp("light","y"),w.lerp("light","z"))},render:(e,t,r=["camera","light","group"].includes(e.type),o)=>{e.t&&(w.gl.bindTexture(3553,w.textures[e.t.id]),w.gl.uniform1i(w.gl.getUniformLocation(w.program,"sampler"),0)),e.f<e.a&&(e.f+=t),e.f>e.a&&(e.f=e.a),w.next[e.n].m=w.animation(e.n),w.next[e.g]&&w.next[e.n].m.preMultiplySelf(w.next[e.g].M||w.next[e.g].m),w.gl.uniformMatrix4fv(w.gl.getUniformLocation(w.program,"m"),!1,(w.next[e.n].M||w.next[e.n].m).toFloat32Array()),w.gl.uniformMatrix4fv(w.gl.getUniformLocation(w.program,"im"),!1,new DOMMatrix(w.next[e.n].M||w.next[e.n].m).invertSelf().toFloat32Array()),r||(w.gl.bindBuffer(34962,w.models[e.type].verticesBuffer),w.gl.vertexAttribPointer(o=w.gl.getAttribLocation(w.program,"pos"),3,5126,!1,0,0),w.gl.enableVertexAttribArray(o),w.models[e.type].uvBuffer&&(w.gl.bindBuffer(34962,w.models[e.type].uvBuffer),w.gl.vertexAttribPointer(o=w.gl.getAttribLocation(w.program,"uv"),2,5126,!1,0,0),w.gl.enableVertexAttribArray(o)),(e.s||w.models[e.type].customNormals)&&w.models[e.type].normalsBuffer&&(w.gl.bindBuffer(34962,w.models[e.type].normalsBuffer),w.gl.vertexAttribPointer(o=w.gl.getAttribLocation(w.program,"normal"),3,5126,!1,0,0),w.gl.enableVertexAttribArray(o)),w.gl.uniform4f(w.gl.getUniformLocation(w.program,"o"),e.s,(3<e.mode||3<w.gl[e.mode])&&!e.ns?1:0,w.ambientLight||.2,e.mix),w.gl.uniform4f(w.gl.getUniformLocation(w.program,"bb"),e.w,e.h,"billboard"==e.type,0),w.models[e.type].indicesBuffer&&w.gl.bindBuffer(34963,w.models[e.type].indicesBuffer),w.gl.vertexAttrib4fv(w.gl.getAttribLocation(w.program,"col"),w.col(e.b)),w.models[e.type].indicesBuffer?w.gl.drawElements(+e.mode||w.gl[e.mode],w.models[e.type].indices.length,5123,0):w.gl.drawArrays(+e.mode||w.gl[e.mode],0,w.models[e.type].vertices.length/3))},lerp:(e,t)=>{var r;return null!=(r=w.next[e])&&r.a?w.current[e][t]+w.next[e].f/w.next[e].a*(w.next[e][t]-w.current[e][t]):w.next[e][t]},animation:(e,t=new DOMMatrix)=>w.next[e]?t.translateSelf(w.lerp(e,"x"),w.lerp(e,"y"),w.lerp(e,"z")).rotateSelf(w.lerp(e,"rx"),w.lerp(e,"ry"),w.lerp(e,"rz")).scaleSelf(w.lerp(e,"w"),w.lerp(e,"h"),w.lerp(e,"d")):t,dist:(e,t=w.next.camera)=>null!=e&&e.m&&null!=t&&t.m?(t.m.m41-e.m.m41)**2+(t.m.m42-e.m.m42)**2+(t.m.m43-e.m.m43)**2:0,ambient:e=>w.ambientLight=e,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(e=>("0x"+e)/(t.length<5?15:255)),1],add:(t,e)=>{(w.models[t]=e).normals&&(w.models[t].customNormals=1),w[t]=e=>w.setState(e,t)},group:e=>w.setState(e,"group"),move:(e,t)=>setTimeout(()=>{w.setState(e)},t||1),delete:(e,t)=>setTimeout(()=>{delete w.next[e]},t||1),camera:(e,t)=>setTimeout(()=>{w.setState(e,e.n="camera")},t||1),light:(e,t)=>t?setTimeout(()=>{w.setState(e,e.n="light")},t):w.setState(e,e.n="light"),smooth:(e,t={},r=[],o,n,i,s,a,l,d,p,c,h,g,m,u)=>{for(w.models[e.type].normals=[],i=0;i<w.models[e.type].vertices.length;i+=3)r.push(w.models[e.type].vertices.slice(i,i+3));for(n=(o=w.models[e.type].indices)?1:(o=r,0),i=0;i<2*o.length;i+=3){var y;s=i%o.length,a=r[p=n?w.models[e.type].indices[s]:s],l=r[c=n?w.models[e.type].indices[1+s]:1+s],d=r[h=n?w.models[e.type].indices[2+s]:2+s],m=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],u=[d[0]-l[0],d[1]-l[1],d[2]-l[2]],g=s<i?[0,0,0]:[m[1]*u[2]-m[2]*u[1],m[2]*u[0]-m[0]*u[2],m[0]*u[1]-m[1]*u[0]],t[y=a[0]+"_"+a[1]+"_"+a[2]]||(t[y]=[0,0,0]),t[y=l[0]+"_"+l[1]+"_"+l[2]]||(t[y]=[0,0,0]),t[y=d[0]+"_"+d[1]+"_"+d[2]]||(t[y]=[0,0,0]),w.models[e.type].normals[p]=t[a[0]+"_"+a[1]+"_"+a[2]]=t[a[0]+"_"+a[1]+"_"+a[2]].map((e,t)=>e+g[t]),w.models[e.type].normals[c]=t[l[0]+"_"+l[1]+"_"+l[2]]=t[l[0]+"_"+l[1]+"_"+l[2]].map((e,t)=>e+g[t]),w.models[e.type].normals[h]=t[d[0]+"_"+d[1]+"_"+d[2]]=t[d[0]+"_"+d[1]+"_"+d[2]].map((e,t)=>e+g[t])}}};w.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),w.add("billboard",w.models.plane);const i=window.document;var k={lockMove:{x:0,y:0},move:{x:0,y:0},wheel:0,click:null,lockElt:null,down:{},isLocked:()=>!!i.pointerLockElement,async lock(){i.pointerLockElement||await this.lockElt.requestPointerLock()},async toggleLock(){i.pointerLockElement?await this.unlock():await this.lock()},async unlock(){await i.exitPointerLock()},getLockMove(){var e={...this.lockMove};return this.lockMove.x=0,this.lockMove.y=0,e},getWheel(){var e=this.wheel;return this.wheel=0,e},getClick(){var e=this.click;return this.click=null,e},setup(n={}){this.lockElt=n.lockElt,onmousemove=e=>{var t=this[i.pointerLockElement?"lockMove":"move"];t.x+=e.movementX,t.y+=e.movementY};const r=e=>1===e.key.length?e.key.toLowerCase():e.key;onkeydown=e=>{var t=r(e);this.down[t]=!0,!e.repeat&&n.keys&&n.keys[t]&&(n.keys[t](),e.preventDefault())},onkeyup=e=>{this.down[r(e)]=!1},onwheel=e=>{this.wheel+=e.deltaY};oncontextmenu=onclick=e=>{var{clientX:t,clientY:r,button:o}=e;e=e.target.dataset.key,e&&n.keys&&n.keys[e]&&n.keys[e](),this.click={clientX:t,clientY:r,button:o,left:0===o,right:2===o,locked:!!i.pointerLockElement}}}};const S=document,re=(e,t)=>S.getElementById(e).innerHTML=t,oe=(e,t,r)=>new E(e,t,r),{sin:o,cos:s,atan2:ne,PI:l,sqrt:ie}=Math;class E{constructor(e=0,t=0,r=0){"object"==typeof e&&(t=e.y,r=e.z,e=e.x),this.x=e,this.y=t,this.z=r}copy(){return new E(this.x,this.y,this.z)}copyTo(e){e.x=this.x,e.y=this.y,e.z=this.z}add(e){return new E(this.x+e.x,this.y+e.y,this.z+e.z)}sub(e){return new E(this.x-e.x,this.y-e.y,this.z-e.z)}length(){return this.lengthSquared()**.5}lengthSquared(){return this.x**2+this.y**2+this.z**2}distance(e){return this.distanceSquared(e)**.5}distanceSquared(e){return(this.x-e.x)**2+(this.y-e.y)**2+(this.z-e.z)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new E(0,e,0)}scale(e){return new E(this.x*e,this.y*e,this.z*e)}cross(e){var{x:t,y:r,z:o}=this;return new E(r*e.z-o*e.y,o*e.x-t*e.z,t*e.y-r*e.x)}rotate(e,t,r){return this.rotateX(e).rotateY(t).rotateZ(r)}rotateX(e=0){var t=this.x,r=this.y*s(e)-this.z*o(e);return e=this.y*o(e)+this.z*s(e),new E(t,r,e)}rotateY(e=0){var t=this.x*s(e)+this.z*o(e),r=this.y;return e=-this.x*o(e)+this.z*s(e),new E(t,r,e)}rotateZ(e=0){var t=this.x*s(e)-this.y*o(e);return e=this.x*o(e)+this.y*s(e),new E(t,e,this.z)}toAngles(e){let{x:t,y:r,z:o}=this;e&&(t=e.x-t,r=e.y-r,o=e.z-o),e=ne(r,t);var n=ne(-o,ie(t*t+r*r)),i=0;return 0===t&&0===r||(i=ie(t*t+r*r),i=ne(o,i)),{roll:i,pitch:n,yaw:e}}toWAngles(e){var{roll:e,pitch:t,yaw:r}=this.toAngles(e);return{rx:180/l*e,ry:180/l*t,rz:180/l*r}}}const d=Math["PI"],se=2*d,ae=t=>new Promise(e=>setTimeout(e,t));let p,M=0;const le=new class{constructor(e){this.seed=e}rand(e=1,t=0){return this.seed^=this.seed<<13,this.seed^=this.seed>>>17,this.seed^=this.seed<<5,t+(e-t)*Math.abs(this.seed%1e9)/1e9}int(e,t=0){return Math.floor(this.rand(e,t))}sign(){return 2*this.randInt(2)-1}}(1234),P=(e=15e3)=>le.rand(-e,e),de={x:0,y:0,z:7500,rx:-90,ry:0,rz:0,vel:{x:0,y:0,z:0},thrust:{x:0,y:0,z:0},thrustForce:.05,fireCooldown:0,r:2,passType:"ship",passthru:["plasma"],sight:1500,aggro:0,thrustCooldown:0,trailCooldown:0,hp:9,maxHp:9,power:100,maxPower:100,recharge:.2,weaponPowerUsage:6,shieldPower:100,enginePowerUsage:.4,shields:0,shieldsDecayAmount:.4,p:1,ignition:0,ignitionSize:.2,facing:{x:0,y:1,z:0},inv:{parts:0},steerPercent:.05,explodes:{colors:["464040","5796a1"],size:1,count:16}},pe={...structuredClone(de),thrustForce:.008,hp:5,passType:"klaxShip",passthru:["klaxPlasma"],facing:{x:1,y:0,z:0},drops:["parts"],explodes:{colors:["464040","702782"],size:5,count:16},isKlax:1},B={},ce={volume:.3,sampleRate:44100,x:new AudioContext,play:function(...e){return this.playSamples(this.buildSamples(...e))},playSamples:function(...e){const r=this.x.createBuffer(e.length,e[0].length,this.sampleRate),t=this.x.createBufferSource();return e.map((e,t)=>r.getChannelData(t).set(e)),t.buffer=r,t.connect(this.x.destination),t.start(),t},buildSamples:function(e=1,t=.05,r=220,o=0,n=0,i=.1,s=0,a=1,l=0,d=0,p=0,c=0,h=0,g=0,m=0,u=0,y=0,f=1,v=0,x=0){var b=2*Math.PI,z=this.sampleRate,w=l*=500*b/z/z;t=r*=(1+2*t*Math.random()-t)*b/z;let k=[],S=0,E=0,M=0,P=1,B=0,C=0,L=0,_;for(d*=500*b/z**3,m*=b/z,p*=b/z,c*=z,h=h*z|0,_=(o=o*z+9)+(v*=z)+(n*=z)+(i*=z)+(y*=z)|0;M<_;k[M++]=L)++C%(100*u|0)||(L=s?1<s?2<s?3<s?Math.sin((S%b)**3):Math.max(Math.min(Math.tan(S),1),-1):1-(2*S/b%2+2)%2:1-4*Math.abs(Math.round(S/b)-S/b):Math.sin(S),L=(h?1-x+x*Math.sin(b*M/h):1)*(0<L?1:-1)*Math.abs(L)**a*e*this.volume*(M<o?M/o:M<o+v?1-(M-o)/v*(1-f):M<o+v+n?f:M<_-y?(_-M-y)/i*f:0),L=y?L/2+(y>M?0:(M<_-y?1:(_-M)/y)*k[M-y|0]/2):L),z=(r+=l+=d)*Math.cos(m*E++),S+=z-z*g*(1-1e9*(Math.sin(M)+1)%2),P&&++P>c&&(r+=p,t+=p,P=0),!h||++B%h||(r=t,l=w,P=P||1);return k},getNote:function(e=0,t=440){return t*2**(e/12)}},{min:C,max:L,round:he,abs:ge,floor:me}=Math,_={W:w,input:k,paused:0,trail:0,nextEnter:0,ogKlaxShipCount:0,klaxShipLeft:0,start(){this.i=setInterval(r,A)},stop(){clearInterval(this.i)},tick:0};let ue,F={};const A=1e3/60,T={back:-1.5,up:.6,rx:80,ry:0,rz:0,zoom:1},I={fov:30,targetFov:30,lastFov:31,aspect:1,near:.5,far:3e4},D={rx:-90,ry:0,rz:0},R="Check steering: [Tab] to toggle mouse-lock;Scan: Hold [C];Thrusters: [W] and [S];Fire weapons: [Click], [F], or [R];Boost: Hold [Shift] with [W] or [S];Shields: [Space];Klaxonian Ships Destroyed: {K} / {S};Ring Repair Parts: {P} / {M}".split(";").map(e=>({t:e,done:0})),ye={plasma:{vScale:45,tScale:.004,damage:1,size:2,sound:[,.1,295,.02,.01,.08,,1.72,-3.5,.2,,,,.2,,,.08,.62,.09]},photon:{vScale:25,tScale:.0012,damage:3,size:2,sound:[2.06,.35,212,.05,.08,.01,,1.66,-4.8,.2,50,,,1.7,,.5,.28,.65,.02]},klaxPlasma:{vScale:45,tScale:.002,damage:1,size:10,sound:[.3,.4,241,.04,.03,.08,,.46,-7.7,,,,,,,.2,,.53,.05,.2]}};addEventListener("DOMContentLoaded",async()=>{e(),await ae(30),r(),await ae(30),_.paused=1,w.camera({x:0,y:0,z:0,rx:-13}),S.getElementById("hi").style.display="flex",_.nextEnter=()=>(S.getElementById("hi").style.display="none",N("<p>A Star-Hopper ship! You heard our distress call? 📡 We're under attack by a Klaxonian fleet!\n\t\tThey've disabled our defenses and solar farms.</p><p>The entire sector is dependent on the POWER generated by our Bunson Ring. ⚡Please rescue us and help get the Ring operational again.</p>")),_.start()}),window.g=_}();