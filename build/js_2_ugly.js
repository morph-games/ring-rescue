!function(){function d(t,r){for(let e=0;e<t;e+=1)r(e,t)}function c(e,t){return{x:t*Math.cos(e),y:t*Math.sin(e)}}function O(e,t){return e.rotate(w/180*t.rx,w/180*t.ry,w/180*t.rz)}function j(e){var t=e["facing"];return O(new k(t,void 0,void 0),e)}function l(e,t=0,r=1){return e<t?t:r<e?r:e}function p(e,t,r){return t+l(e)*(r-t)}function h(e=1,t=0){return t+Math.random()*(e-t)}function m(e,t=0){return Math.floor(h(e,t))}function g(e,t){var r=b.getElementById(e),n=r||b.createElement("canvas");return n.id=e,n.width=n.height=t,r||b.getElementById("loaded").appendChild(n),[n,n.getContext("2d"),t/2]}function o(e=4,t="#f00",r,n=.4,o=600){const[a,i,s]=g(r,o),l=(i.clearRect(0,0,o,o),i.beginPath(),re/e);return d(e,e=>{var{x:t,y:r}=c(l*e,s),{x:t,y:r}=(i.lineTo(s+t,s+r),c(l*e+l/2,s*n));i.lineTo(s+t,s+r)}),i.fillStyle=t,i.fill(),a}function U(e){const[t,s]=g("rabbit"+e,600);s.beginPath(),s.moveTo(10,600);var r=[[10,600],[50,550],[100,520],[270,480],[270,450]];return r.forEach(e=>s.lineTo(...e)),r.reverse().forEach(([e,t])=>s.lineTo(600-e,t)),s.fillStyle="#5796a1",s.fill(),s.closePath(),r=(e,t,r,n,o=0,a="#eee",i={})=>{s.beginPath(),s.ellipse(e,t,r,n,o,0,re),s.fillStyle=a,s.fill(),i.hook&&i.hook(),s.closePath()},e&&r(300,400,100,160,0,"#8bc7bf"),r(300,300,200,70),r(300,350,250,100),r(300,410,200,60),r(150,200,200,40,.4*S),r(450,200,200,40,.4*-S),e&&(r(430,320,20,30,0,"#445"),r(170,320,20,30,0,"#445"),r(440,290,16,40,-1.4*S,"#ccc"),r(160,290,16,40,1.4*S,"#ccc"),r(300,350,20,10,0,"#de8b6f"),s.beginPath(),s.moveTo(300,450),s.lineTo(150,400),s.lineTo(450,400),s.fillStyle="#222",s.fill(),s.closePath()),r(300,320,290,180,0,"#ffffff55",{hook:()=>{s.strokeStyle="#8bc7bf",s.lineWidth=10,s.stroke()}}),t}function W(e){const t="k"+e;var r={x:B(2e3),y:B(2e3),z:B(2e3)};e={n:t,...structuredClone(ie),...r,size:5,r:10,isGroup:1},E.group({n:t,g:"system",...r});const n={g:t,size:2.5,x:-1.5,b:"372b4e"};r={g:t,size:2,b:"471b6e"},E.cube({...n,n:t+"c",rx:45,b:"471b6e"}),d(4,e=>{E.cube({...n,n:t+"cc"+e,x:-2-e,size:2.5-.5*e})}),E.pyramid({n:t+"nose",rz:-90,g:t,size:1.5,b:"90d59c"}),E.longRect({...r,n:t+"wing1",y:2,rx:90,ry:45,rz:-45}),E.longRect({...r,n:t+"wing2",y:2,x:1.5,rx:90,ry:45,rz:45,b:"471b6e"}),E.longRect({...r,n:t+"wing3",y:-2,rx:90,ry:45,rz:45}),E.longRect({...r,n:t+"wing4",y:-2,x:1.5,rx:90,ry:45,rz:-45,b:"471b6e"}),E.sphere({n:t+"shield",g:t,size:10,b:"ebd69404"}),le.push(e),P[e.n]=e,se.push(e)}function K(e,r){E=e;const t=(e,t)=>{var r={n:e,rx:0,ry:0,rz:0};t&&(r.g=t),E.group(r),de[e]=r},a=(t("system"),"sun ring p1 p2 p3 a1 a2 a3".split(" ").forEach(e=>t(e,"system")),["ship","skybox"].forEach(e=>E.group({n:e})),e={shape:"simpleSphere",b:"775b5b"},[{shape:"sphere",n:"outerSun",g:"sun",size:500,b:"#de8b6f88"},{shape:"sphere",n:"innerSun",g:"sun",size:480,b:"#de8b6f"},{shape:"billboard",n:"sunFlare",g:"sun",size:640,b:"#de8b6f",t:o(16,"#de8b6f88","sun",.7)},{shape:"sphere",n:"planet1",g:"p1",...c(.5,3e3),size:200,b:"775b5b",s:1},{shape:"sphere",n:"planet2",g:"p2",...c(.7,4e3),size:120,b:"#b0455a",s:1},{shape:"sphere",n:"planet3",g:"p3",...c(2,7e3),size:80,b:"775b5b",s:1},{...e,n:"asteroid1",g:"a1",...c(3,1e3),size:30},{...e,n:"asteroid2",g:"a2",...c(3.5,2e3/1.7),size:35},{...e,n:"asteroid3",g:"a3",...c(5,2e3/1.8),size:40}].forEach(e=>{E[e.shape](e),P[e.n]=e}),e=function(e,t){const[r,n]=g(e,800);return d(1400,()=>{n.rect(t.int(0,800),t.int(0,800),1,1)}),n.fillStyle="#ebd694",n.fill(),r}("sf",oe),[{z:-r,b:"0000",t:e},{y:-r,rx:-90,b:"0000",t:e},{y:r,rx:90,b:"0000",t:e},{x:-r,ry:90,b:"0000",t:e},{x:r,ry:-90,b:"0000",t:e},{z:r,rx:180,b:"0000",t:e}].forEach((e,t)=>{E.plane({b:"000",...e,n:"skybox"+t,g:"skybox",size:2*r})}),E.longPyramid({n:"shipBase",g:"ship",size:.18,y:.18,b:"5796a1"}),E.ufo({n:"shipBody",g:"ship",y:-.06,rx:90,size:.39,b:"5796a1",s:1}),E.ufo({n:"sCockpit",g:"ship",y:-.06,rx:90,z:.12,size:.15,b:"666c",s:1}),e={n:"shipComp1",g:"ship",x:-.09,y:-.21,ry:0,size:.12,b:"5796a1"},E.cube(e),E.cube({...e,n:"shipComp2",x:-e.x}),e={n:"shipEngine1",g:"ship",ry:45,rx:90,x:.33,y:-.09,size:.3,b:"8bc7bf"},E.longerRect(e),E.longerRect({...e,n:"shipEngine2",x:-.33}),e={n:"shipEngineBack1",g:"ship",x:.33,y:-.3,size:.3/3,b:"5796a1"},E.longPyramid(e),E.longPyramid({...e,n:"shipEngineBack2",x:-.33}),E.plank({n:"sWing1",g:"ship",rx:90,ry:90,x:-0,y:-.09,z:0,size:.03,b:"5796a1"}),e={g:"ship",n:"sFlame1",rx:180,x:.33,y:-.42,size:.078,b:"ebd69400"},E.longPyramid(e),E.longPyramid({...e,n:"sFlame2",x:-.33}),d(6,W),2*Math.PI);return d(32,(e,t)=>{var r=0===e?0:a*e/t,{x:n,y:o}=(t=180/w*r,c(r,2e3)),r="r"+e;E.group({n:r,g:"ring"}),E.plank({n:"ring"+e,g:r,x:n,y:o,rz:t,size:20,b:"#5796a1"}),E.cube({n:"ringBuilding"+e,g:r,x:n,y:o,rz:t,size:50,b:"478691"})}),d(200,e=>{E.billboard({n:"litter"+e,g:"system",x:B(3e3),y:B(3e3),z:B(3e3),size:1,b:"555e"})}),d(10,e=>{var t=(t="de8b6f 471b6e 524bb3 5796a1 464040 775b5b".split(" "))[m(0,t.length)];e={n:"crate"+e,passType:"crate",passthru:["crate"],g:"system",x:B(3e3),y:B(3e3),z:B(3e3),vel:{...new k(void 0,void 0,void 0)},size:20,r:20,b:t,rx:h(0,359),ry:h(0,359),rz:h(0,359),hp:3,drops:["parts"],explodes:{colors:["464040",t],size:2,count:10}},le.push(e),P[e.n]=e,E.cube(e)}),{groups:de,ship:ae,renderables:P,physicsEnts:le,klaxShips:se}}function a(e,{x:t=.5,y:r=.5,z:n=.5}={}){x.add(e,{vertices:[t,r,n,-t,r,n,-t,-r,n,t,r,n,-t,-r,n,t,-r,n,t,r,-n,t,r,n,t,-r,n,t,r,-n,t,-r,n,t,-r,-n,t,r,-n,-t,r,-n,-t,r,n,t,r,-n,-t,r,n,t,r,n,-t,r,n,-t,r,-n,-t,-r,-n,-t,r,n,-t,-r,-n,-t,-r,n,-t,r,-n,t,r,-n,t,-r,-n,-t,r,-n,t,-r,-n,-t,-r,-n,t,-r,n,-t,-r,n,-t,-r,-n,t,-r,n,-t,-r,-n,t,-r,-n],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]})}function Y(e,{x:t=.5,y:r=.5,z:n=.5}={}){x.add(e,{vertices:[-t,-r,n,t,-r,n,0,r,0,t,-r,n,t,-r,-n,0,r,0,t,-r,-n,-t,-r,-n,0,r,0,-t,-r,-n,-t,-r,n,0,r,0,t,-r,n,-t,-r,n,-t,-r,-n,t,-r,n,-t,-r,-n,t,-r,-n],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]})}function i(e,{x:t=2,y:r=2,z:n=2,precision:o=20,i:a,ai:i,j:s,aj:l,p1:d,p2:c,vertices:p=[],indices:h=[],uv:g=[]}={}){var{PI:m,sin:u,cos:y}=Math;for(s=0;s<=o;s++)for(l=s*m/o,a=0;a<=o;a++)p.push(+(u(i=2*a*m/o)*u(l)/t).toFixed(6),+(y(l)/r).toFixed(6),+(y(i)*u(l)/n).toFixed(6)),g.push(3.5*u(a/o),-u(s/o)),a<o&&s<o&&h.push(d=s*(o+1)+a,c=d+(o+1),d+1,d+1,c,c+1);x.add(e,{vertices:p,uv:g,indices:h})}function u(...e){ce.play(...e)}function y(e){if(void 0!==e){if(R[e].done)return;R[e].done=1}e=_.klaxShips.filter(e=>0<e.hp).length;var r,t=L.ogKlaxShipCount-e;0===e&&(R[5].done=1),7<=(ship.inv.parts||0)&&(R[6].done=1),r=t,e=R.map(({t:e,done:t})=>`<li class="${t?"done":""}">${e.replace("{K}",r).replace("{S}",L.ogKlaxShipCount).replace("{P}",ship.inv.parts||0).replace("{M}",7)}</li>`).join(""),b.getElementById("goals").innerHTML=e,R.length===R.filter(e=>e.done).length&&q("You did it! With those parts we should be able to get the Ring powered up again.<p>Thank you!</p>")}function q(e){u(2.36,0,130.8128,.02,.51,.2,void 0,1.91,void 0,void 0,void 0,void 0,.08,void 0,void 0,void 0,.04,.5,void 0,.39),L.paused=1;const t=b.getElementById("dialog").classList,r=b.getElementById("goals").style;return r.opacity="0",v.unlock(),J("pic",`<img src="${T.rabbit.toDataURL()}" />`),J("txt",e+'<i data-key="Enter">Close [Enter]</i>'),t.add("show"),x.camera({x:0,y:100,z:0,a:200},500),L.W.move({n:"system",x:1e3,y:-500,z:-2500,a:2e3},500),L.nextEnter=()=>{r.opacity="1",t.remove("show"),L.paused=0,b.querySelector("main").classList.remove("ui--off")}}function e(){var e,t,r,n=b.getElementById("canvas");t=(e=n).clientWidth,(r=e.clientHeight)<t?(I.aspect=t/r,e.height=pe(t,800),e.width=t/I.aspect):(e.width=e.height=pe(t,800),I.aspect=1),v.setup({lockElt:n,keys:{Tab:()=>{y(0),v.toggleLock()},p:()=>{L.paused=!L.paused},Enter:()=>{L.nextEnter&&(L.nextEnter=L.nextEnter())}}}),T={tf:o(9,"#ebd694","tf",.3),plasma:o(11,"#de8b6f","plasma",.2),photon:o(13,"#b0455a","photon",.5),klaxPlasma:o(15,"#90d59c","klaxPlasma",.3),rabbit:U(1),pilot:U(0)},n.addEventListener("click",()=>{v.lock()}),x.reset(n),x.clearColor("2a242b"),x.light({x:-1,y:-1.2,z:.2}),x.ambient(.8),a("plank",{y:10,z:5,x:.3}),a("longRect",{x:.2,y:.2}),a("longerRect",{x:.2,y:.2,z:.7}),a("cube"),Y("pyramid"),Y("longPyramid",{y:.8}),i("sphere"),i("simpleSphere",{precision:6}),i("ufo",{y:3,precision:10}),_=K(x,15e3),["renderables","ship","physicsEnts","klaxShips"].forEach(e=>{window[e]=_[e],L[e]=_[e]}),_.klaxShips.forEach((e,t)=>{x.billboard({n:"scan"+t,g:"system",x:e.x,y:e.y,z:e.z,size:100,b:"90d59c"})}),L.ogKlaxShipCount=_.klaxShips.length,y()}function H(e,t=0){var{x:t,y:r,z:n}=j(e).scale(t);e.thrust={x:t,y:r,z:n}}function V(t){return 0<["x","y","z"].filter(e=>15e3<=t[e]||t[e]<=-15e3).length}function X(e,t){var r,n,o;e.damage&&t.hp&&(r=t===ship,console.log("Damage",t.n),t.hp-=e.damage,e.destroyOnDamage&&(e.decay=0),t.hp<=0?(console.log("Destroy",t.n),t.decay=0,t.drops&&t.drops.forEach(e=>ship.inv[e]=(ship.inv[e]||0)+1),t.explodes&&f(t),y()):f({x:t.x,y:t.y,z:t.z,explodes:{count:10}}),u(r?1.5:.7,void 0,416,.02,.21,.52,4,2.14,.2,void 0,void 0,void 0,void 0,1.7,void 0,.9,void 0,.44,.12,.23),r)&&(r="canvas",n="#b0455a",o=1500,new Animation(new KeyframeEffect(b.getElementById(r),[{borderColor:n},{borderColor:"#000"}],{duration:o,direction:"alternate",easing:"linear"}),b.timeline).play()),e.aggro+=1,t.aggro+=1,e.shieldOpacity+=5,t.shieldOpacity+=5}function $(t){d(t.length,e=>{var r,n;r=t[e],n=t,r.collided||d(n.length,e=>{var t,i,s;e=n[e],r.passthru&&r.passthru.includes(e.passType)||e.passthru&&e.passthru.includes(r.passType)||r===e||e.collided||(t=new k(r,void 0,void 0).distance(e))<=r.r+e.r&&(s=e,e=t,X(((i=r).collided=s).collided=i,s),X(s,i),e=new k(s,void 0,void 0).sub(i).normalize().scale((i.r+s.r-e)/2),new k(i,void 0,void 0).sub(e).copyTo(i),new k(s,void 0,void 0).add(e).copyTo(s),["x","y","z"].forEach(e=>{var t=i.mass||1,r=s.mass||1,n=t+r,o=i.vel[e],a=s.vel[e];i.vel[e]=(t-r)/n*o+2*r/n*a,s.vel[e]=2*t/n*o+(r-t)/n*a}))})})}function N(t,r,e=0){const{steerPercent:n=.01}=t;["rx","ry","rz"].forEach(e=>t[e]=p(n,t[e],r[e])),e&&(t.ry=p(.1,t.ry,r.ry+e))}function G(e,t,r,n){var{vScale:o,tScale:a,damage:i,size:s,sound:l}=me[e],d=T[e],c=j(t),{x:p,y:h,z:g}=new k(t,void 0,void 0).add(c.normalize(t.size));t=c.scale(o).add(t.vel),u(...l),e={n:e+r+(String(Number(new Date))+m(999)),g:"system",passType:r,x:p,y:h,z:g,vel:{...t},thrust:{...c.scale(a)},decay:6,damage:i,r:5,passthru:n,mass:.01,size:s,destroyOnDamage:1},physicsEnts.push(e),renderables[e.n]=e,x.billboard({...e,t:d})}function f(r){let{x:n,y:o,z:a,explodes:e={}}=r;const{count:t=20,size:i=2,colors:s=["464040","de8b6f","b0455a"]}=e;console.log("Exploding for",r.n,t),d(t,()=>{const t=Q(r.vel||{x:0,y:0,z:0});["x","y","z"].forEach(e=>{t[e]+=h(-20,20)});var e={n:"explosion"+(String(Number(new Date))+m(999)),x:n+h(-.5,.5),y:o+h(-.5,.5),z:a+h(-.5,.5),vel:t,decay:h(1,10),r:1,g:"system",size:C(i+h(-i/2,i/2),.2),passType:"dust",passthru:["dust"],mass:.01,b:s[m(0,s.length)],destroyOnDamage:1};physicsEnts.push(e),renderables[e.n]=e,x.billboard({...e})})}function Z(t,e){var r=e.findIndex(e=>e.n===t);-1!==r&&e.splice(r,1)}function r(){var a,r,e,t,n,o,i,s;L.paused||(a=F/1e3,r=v["down"],r["]"]&&(I.targetFov+=.5),r["["]&&(I.targetFov-=.5),e=v.getWheel(),(r["-"]||0<e)&&(A.zoom=l(A.zoom+.1,0,100)),(r["="]||r["+"]||e<0)&&(A.zoom=l(A.zoom+-.1,0,100)),r.p)||(o=r.a?90:r.d?-90:0,t=0,1<(e=r.Shift?2:1)&&y(4),r.s?(t=ship.thrustForce*e*-.5,r.w=0):r.w&&(t=ship.thrustForce*e),H(ship,t),i=0<t?"ebd694dd":"ebd69400",x.move({n:"sFlame1",b:i}),x.move({n:"sFlame2",b:i}),0===t?(x.delete("sIgnite1"),x.delete("sIgnite2")):(u(1<e?.15:.1,void 0,794,.02,.3,.32,void 0,3.96,void 0,.7,void 0,void 0,.16,2.1,void 0,1<e?.2:.8,.1,.31,.27),y(2),i={g:"ship",y:-.393,rx:70,size:.2,t:T.tf},x.billboard({...i,n:"sIgnite1",x:-.33}),x.billboard({...i,n:"sIgnite2",x:.33})),i=v.getClick(),0===ship.fireCooldown&&(r[" "]||i&&i.locked)&&(y(3),G(i&&i.right?"photon":"plasma",ship,"plasma",["ship","plasma","klaxPlasma"]),ship.fireCooldown=.3),r.f&&f(ship,ship.explodes),r.c&&y(1),klaxShips.forEach((e,t)=>{x.move({n:"scan"+t,x:e.x,y:e.y,z:e.z,size:100,b:0<e.hp&&r.c?"90d59c":"0000"})}),ship.fireCooldown=C(ship.fireCooldown-a,0),klaxShips.forEach(e=>{var t,r;e.decay<=0||e.hp<=0||((r=(t=new k(e,void 0,void 0)).distance(ship))>2*e.sight?e.aggro=C(0,e.aggro-=.1):r<=e.sight&&(e.aggro=C(1,e.aggro)),e.aggro&&(N(e,t=t.toWAngles(ship)),e.thrustCooldown?e.thrustCooldown=C(e.thrustCooldown-a,0):(H(e,e.thrustForce),e.thrustCooldown=h(.5,1)),e.fireCooldown?e.fireCooldown=C(e.fireCooldown-a,0):(G("klaxPlasma",e,"klaxPlasma",["klaxShip","klaxPlasma","plasma"]),e.fireCooldown=h(.3,3))))}),$(physicsEnts),physicsEnts.forEach(e=>{e.collided=0;var t=e,r=a,{friction:e=1}=t,n=(e*=.25,V(t)&&(e*=10),new k(t.vel,void 0,void 0)),o=new k(t.thrust||void 0,void 0,void 0).scale(1/(t.mass||1));t.vel=n.sub(n.normalize(e)).add(o.scale(1/r)),800<(e=t.vel.length())?t.vel=t.vel.normalize(800):e<1e-4&&(t.vel=new k(void 0,void 0,void 0)),["x","y","z"].forEach(e=>{t[e]=l(t[e]+t.vel[e]*r,-15e3,15e3),V(t)&&t.decay&&(t.decay=0)})}),ship.hp<=0?(L.paused=1,v.unlock(),b.querySelector("main").classList.add("end"),b.getElementById("end").style.display="flex"):(i=v.getLockMove(),D.ry-=i.x/10,D.rx=pe(C(D.rx-i.y/10,-180),0),N(ship,D,o),o=O(new k(0,A.back,A.up).scale(A.zoom),D),I.fov=p(.1,I.fov,I.targetFov+(t?t<0?-2:1<e?10:1:0)),e=.001<ge(I.fov-I.lastFov),I.lastFov=I.fov,t={...o,...function(e,t){var{rx:e,ry:r,rz:n}=e;return{rx:e+=t.rx,ry:r+=t.ry,rz:n+=t.rz}}(A,D),a:100},e&&(t={...t,...I}),x.camera(t),{rx:i,ry:o,rz:n}=ship,x.move({n:"ship",rx:i,ry:o,rz:n}),Object.keys(renderables).forEach(e=>{var t=renderables[e];"number"==typeof t.decay&&(t.decay-=a,t.decay<=0)&&(t.isGroup?x.move({n:t.n,x:6e4}):x.delete(t.n),Z(t.n,physicsEnts),Z(t.n,klaxShips),delete renderables[e])}),e={...renderables},t={x:-ship.x,y:-ship.y,z:-ship.z,a:F},M+=F/90,s={...e,system:t,innerSun:{rx:M,ry:.9*M},p1:{rz:.1*M},p2:{rz:.15*M},p3:{rz:.05*M},ring:{rz:.5*M},a1:{rz:.7*M},a2:{rz:.6*M},a3:{rz:.5*M}},Object.keys(s).forEach(e=>{x.move({n:e,...s[e]},0)}),o=(i=new k(ship.vel,void 0,void 0)).x>i.y&&i.x>i.z?"X":i.y>i.x&&i.y>i.z?"Y":"Z",i="<b>"+[`Velocity: ${he(i.length())} (${o})`,`Pitch: ${he(D.rx+90)}, Yaw: `+he(D.ry)%360,"Hull: "+ship.hp].join("</b><b>")+"</b>",b.getElementById("si").innerHTML=i))}let t,x={models:{},reset:e=>{x.canvas=e,x.objs=0,x.current={},x.next={},x.textures={},x.gl=e.getContext("webgl2"),x.gl.blendFunc(770,771),x.gl.activeTexture(33984),x.program=x.gl.createProgram(),x.gl.enable(2884),x.gl.shaderSource(t=x.gl.createShader(35633),"#version 300 es\n      precision highp float;                        // Set default float precision\n      in vec4 pos, col, uv, normal;                 // Vertex attributes: position, color, texture coordinates, normal (if any)\n      uniform mat4 pv, eye, m, im;                  // Uniform transformation matrices: projection * view, eye, model, inverse model\n      uniform vec4 bb;                              // If the current shape is a billboard: bb = [w, h, 1.0, 0.0]\n      out vec4 v_pos, v_col, v_uv, v_normal;        // Varyings sent to the fragment shader: position, color, texture coordinates, normal (if any)\n      void main() {                                 \n        gl_Position = pv * (                        // Set vertex position: p * v * v_pos\n          v_pos = bb.z > 0.                         // Set v_pos varying:\n          ? m[3] + eye * (pos * bb)                 // Billboards always face the camera:  p * v * distance + eye * (position * [w, h, 1.0, 0.0])\n          : m * pos                                 // Other objects rotate normally:      p * v * m * position\n        );                                          \n        v_col = col;                                // Set varyings \n        v_uv = uv;\n        v_normal = transpose(inverse(m)) * normal;  // recompute normals to match model thansformation\n      }"),x.gl.compileShader(t),x.gl.attachShader(x.program,t),console.log("vertex shader:",x.gl.getShaderInfoLog(t)||"OK"),x.gl.shaderSource(t=x.gl.createShader(35632),"#version 300 es\n      precision highp float;                  // Set default float precision\n      in vec4 v_pos, v_col, v_uv, v_normal;   // Varyings received from the vertex shader: position, color, texture coordinates, normal (if any)\n      uniform vec3 light;                     // Uniform: light direction, smooth normals enabled\n      uniform vec4 o;                         // options [smooth, shading enabled, ambient, mix]\n      uniform sampler2D sampler;              // Uniform: 2D texture\n      out vec4 c;                             // Output: final fragment color\n\n      // The code below displays colored / textured / shaded fragments\n      void main() {\n        c = mix(texture(sampler, v_uv.xy), v_col, o[3]);  // base color (mix of texture and rgba)\n        if(o[1] > 0.){                                    // if lighting/shading is enabled:\n          c = vec4(                                       // output = vec4(base color RGB * (directional shading + ambient light)), base color Alpha\n            c.rgb * (max(0., dot(light, -normalize(       // Directional shading: compute dot product of light direction and normal (0 if negative)\n              o[0] > 0.                                   // if smooth shading is enabled:\n              ? vec3(v_normal.xyz)                        // use smooth normals passed as varying\n              : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))   // else, compute flat normal by making a cross-product with the current fragment and its x/y neighbours\n            )))\n            + o[2]),                                      // add ambient light passed as uniform\n            c.a                                           // use base color's alpha\n          );\n        }\n      }"),x.gl.compileShader(t),x.gl.attachShader(x.program,t),console.log("fragment shader:",x.gl.getShaderInfoLog(t)||"OK"),x.gl.linkProgram(x.program),x.gl.useProgram(x.program),console.log("program:",x.gl.getProgramInfoLog(x.program)||"OK"),x.gl.clearColor(1,1,1,1),x.clearColor=e=>x.gl.clearColor(...x.col(e)),x.clearColor("fff"),x.gl.enable(2929),x.light({y:-1}),x.camera({fov:30}),setTimeout(x.draw,16)},setState:(e,t,r)=>{var n,o,a,i,s;(n=e).n||(n.n="o"+x.objs++),e.size&&(e.w=e.h=e.d=e.size),e.t&&e.t.width&&!x.textures[e.t.id]&&(r=x.gl.createTexture(),x.gl.pixelStorei(37441,!0),x.gl.bindTexture(3553,r),x.gl.pixelStorei(37440,1),x.gl.texImage2D(3553,0,6408,6408,5121,e.t),x.gl.generateMipmap(3553),x.textures[e.t.id]=r),e.fov&&({near:s=1,far:o=1e3,fov:a,aspect:i=canvas.width/canvas.height}=e,r=1/Math.tan(a*Math.PI/180),n=1/(s-o),x.projection=new DOMMatrix([r/i,0,0,0,0,r,0,0,0,0,(o+s)*n,-1,0,0,2*s*o*n,0])),e={type:t,...x.current[e.n]=x.next[e.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0},...e,f:0},null==(a=x.models[e.type])||!a.vertices||null!=(i=x.models)&&i[e.type].verticesBuffer||(x.gl.bindBuffer(34962,x.models[e.type].verticesBuffer=x.gl.createBuffer()),x.gl.bufferData(34962,new Float32Array(x.models[e.type].vertices),35044),!x.models[e.type].normals&&x.smooth&&x.smooth(e),x.models[e.type].normals&&(x.gl.bindBuffer(34962,x.models[e.type].normalsBuffer=x.gl.createBuffer()),x.gl.bufferData(34962,new Float32Array(x.models[e.type].normals.flat()),35044))),null!=(r=x.models[e.type])&&r.uv&&!x.models[e.type].uvBuffer&&(x.gl.bindBuffer(34962,x.models[e.type].uvBuffer=x.gl.createBuffer()),x.gl.bufferData(34962,new Float32Array(x.models[e.type].uv),35044)),null!=(s=x.models[e.type])&&s.indices&&!x.models[e.type].indicesBuffer&&(x.gl.bindBuffer(34963,x.models[e.type].indicesBuffer=x.gl.createBuffer()),x.gl.bufferData(34963,new Uint16Array(x.models[e.type].indices),35044)),e.t?e.t&&!e.mix&&(e.mix=0):e.mix=1,x.next[e.n]=e},draw:(e,t,r,n,o=[])=>{for(n in t=e-x.lastFrame,x.lastFrame=e,requestAnimationFrame(x.draw),x.next.camera.g&&x.render(x.next[x.next.camera.g],t,1),r=x.animation("camera"),null!=(e=x.next)&&null!=(e=e.camera)&&e.g&&r.preMultiplySelf(x.next[x.next.camera.g].M||x.next[x.next.camera.g].m),x.gl.uniformMatrix4fv(x.gl.getUniformLocation(x.program,"eye"),!1,r.toFloat32Array()),r.invertSelf(),r.preMultiplySelf(x.projection),x.gl.uniformMatrix4fv(x.gl.getUniformLocation(x.program,"pv"),!1,r.toFloat32Array()),x.gl.clear(16640),x.next)x.next[n].t||1!=x.col(x.next[n].b)[3]?o.push(x.next[n]):x.render(x.next[n],t);o.sort((e,t)=>x.dist(t)-x.dist(e)),x.gl.enable(3042);for(n of o)["plane","billboard"].includes(n.type)&&x.gl.depthMask(0),x.render(n,t),x.gl.depthMask(1);x.gl.disable(3042),x.gl.uniform3f(x.gl.getUniformLocation(x.program,"light"),x.lerp("light","x"),x.lerp("light","y"),x.lerp("light","z"))},render:(e,t,r=["camera","light","group"].includes(e.type),n)=>{e.t&&(x.gl.bindTexture(3553,x.textures[e.t.id]),x.gl.uniform1i(x.gl.getUniformLocation(x.program,"sampler"),0)),e.f<e.a&&(e.f+=t),e.f>e.a&&(e.f=e.a),x.next[e.n].m=x.animation(e.n),x.next[e.g]&&x.next[e.n].m.preMultiplySelf(x.next[e.g].M||x.next[e.g].m),x.gl.uniformMatrix4fv(x.gl.getUniformLocation(x.program,"m"),!1,(x.next[e.n].M||x.next[e.n].m).toFloat32Array()),x.gl.uniformMatrix4fv(x.gl.getUniformLocation(x.program,"im"),!1,new DOMMatrix(x.next[e.n].M||x.next[e.n].m).invertSelf().toFloat32Array()),r||(x.gl.bindBuffer(34962,x.models[e.type].verticesBuffer),x.gl.vertexAttribPointer(n=x.gl.getAttribLocation(x.program,"pos"),3,5126,!1,0,0),x.gl.enableVertexAttribArray(n),x.models[e.type].uvBuffer&&(x.gl.bindBuffer(34962,x.models[e.type].uvBuffer),x.gl.vertexAttribPointer(n=x.gl.getAttribLocation(x.program,"uv"),2,5126,!1,0,0),x.gl.enableVertexAttribArray(n)),(e.s||x.models[e.type].customNormals)&&x.models[e.type].normalsBuffer&&(x.gl.bindBuffer(34962,x.models[e.type].normalsBuffer),x.gl.vertexAttribPointer(n=x.gl.getAttribLocation(x.program,"normal"),3,5126,!1,0,0),x.gl.enableVertexAttribArray(n)),x.gl.uniform4f(x.gl.getUniformLocation(x.program,"o"),e.s,(3<e.mode||3<x.gl[e.mode])&&!e.ns?1:0,x.ambientLight||.2,e.mix),x.gl.uniform4f(x.gl.getUniformLocation(x.program,"bb"),e.w,e.h,"billboard"==e.type,0),x.models[e.type].indicesBuffer&&x.gl.bindBuffer(34963,x.models[e.type].indicesBuffer),x.gl.vertexAttrib4fv(x.gl.getAttribLocation(x.program,"col"),x.col(e.b)),x.models[e.type].indicesBuffer?x.gl.drawElements(+e.mode||x.gl[e.mode],x.models[e.type].indices.length,5123,0):x.gl.drawArrays(+e.mode||x.gl[e.mode],0,x.models[e.type].vertices.length/3))},lerp:(e,t)=>{var r;return null!=(r=x.next[e])&&r.a?x.current[e][t]+x.next[e].f/x.next[e].a*(x.next[e][t]-x.current[e][t]):x.next[e][t]},animation:(e,t=new DOMMatrix)=>x.next[e]?t.translateSelf(x.lerp(e,"x"),x.lerp(e,"y"),x.lerp(e,"z")).rotateSelf(x.lerp(e,"rx"),x.lerp(e,"ry"),x.lerp(e,"rz")).scaleSelf(x.lerp(e,"w"),x.lerp(e,"h"),x.lerp(e,"d")):t,dist:(e,t=x.next.camera)=>null!=e&&e.m&&null!=t&&t.m?(t.m.m41-e.m.m41)**2+(t.m.m42-e.m.m42)**2+(t.m.m43-e.m.m43)**2:0,ambient:e=>x.ambientLight=e,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(e=>("0x"+e)/(t.length<5?15:255)),1],add:(t,e)=>{(x.models[t]=e).normals&&(x.models[t].customNormals=1),x[t]=e=>x.setState(e,t)},group:e=>x.setState(e,"group"),move:(e,t)=>setTimeout(()=>{x.setState(e)},t||1),delete:(e,t)=>setTimeout(()=>{delete x.next[e]},t||1),camera:(e,t)=>setTimeout(()=>{x.setState(e,e.n="camera")},t||1),light:(e,t)=>t?setTimeout(()=>{x.setState(e,e.n="light")},t):x.setState(e,e.n="light"),smooth:(e,t={},r=[],n,o,a,i,s,l,d,c,p,h,g,m,u)=>{for(x.models[e.type].normals=[],a=0;a<x.models[e.type].vertices.length;a+=3)r.push(x.models[e.type].vertices.slice(a,a+3));for(o=(n=x.models[e.type].indices)?1:(n=r,0),a=0;a<2*n.length;a+=3){var y;i=a%n.length,s=r[c=o?x.models[e.type].indices[i]:i],l=r[p=o?x.models[e.type].indices[1+i]:1+i],d=r[h=o?x.models[e.type].indices[2+i]:2+i],m=[l[0]-s[0],l[1]-s[1],l[2]-s[2]],u=[d[0]-l[0],d[1]-l[1],d[2]-l[2]],g=i<a?[0,0,0]:[m[1]*u[2]-m[2]*u[1],m[2]*u[0]-m[0]*u[2],m[0]*u[1]-m[1]*u[0]],t[y=s[0]+"_"+s[1]+"_"+s[2]]||(t[y]=[0,0,0]),t[y=l[0]+"_"+l[1]+"_"+l[2]]||(t[y]=[0,0,0]),t[y=d[0]+"_"+d[1]+"_"+d[2]]||(t[y]=[0,0,0]),x.models[e.type].normals[c]=t[s[0]+"_"+s[1]+"_"+s[2]]=t[s[0]+"_"+s[1]+"_"+s[2]].map((e,t)=>e+g[t]),x.models[e.type].normals[p]=t[l[0]+"_"+l[1]+"_"+l[2]]=t[l[0]+"_"+l[1]+"_"+l[2]].map((e,t)=>e+g[t]),x.models[e.type].normals[h]=t[d[0]+"_"+d[1]+"_"+d[2]]=t[d[0]+"_"+d[1]+"_"+d[2]].map((e,t)=>e+g[t])}}};x.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),x.add("billboard",x.models.plane);const s=window.document;var v={lockMove:{x:0,y:0},move:{x:0,y:0},wheel:0,click:null,lockElt:null,down:{},isLocked:()=>!!s.pointerLockElement,async lock(){s.pointerLockElement||await this.lockElt.requestPointerLock()},async toggleLock(){s.pointerLockElement?await this.unlock():await this.lock()},async unlock(){await s.exitPointerLock()},getLockMove(){var e={...this.lockMove};return this.lockMove.x=0,this.lockMove.y=0,e},getWheel(){var e=this.wheel;return this.wheel=0,e},getClick(){var e=this.click;return this.click=null,e},setup(o={}){this.lockElt=o.lockElt,onmousemove=e=>{var t=this[s.pointerLockElement?"lockMove":"move"];t.x+=e.movementX,t.y+=e.movementY};const r=e=>1===e.key.length?e.key.toLowerCase():e.key;onkeydown=e=>{var t=r(e);this.down[t]=!0,!e.repeat&&o.keys&&o.keys[t]&&(o.keys[t](),e.preventDefault())},onkeyup=e=>{this.down[r(e)]=!1},onwheel=e=>{this.wheel+=e.deltaY};oncontextmenu=onclick=e=>{var{clientX:t,clientY:r,button:n}=e;e=e.target.dataset.key,e&&o.keys&&o.keys[e]&&o.keys[e](),this.click={clientX:t,clientY:r,button:n,left:0===n,right:2===n,locked:!!s.pointerLockElement}}}};const b=document,J=(e,t)=>b.getElementById(e).innerHTML=t,Q=(e,t,r)=>new k(e,t,r),{sin:n,cos:z,atan2:ee,PI:w,sqrt:te}=Math;class k{constructor(e=0,t=0,r=0){"object"==typeof e&&(t=e.y,r=e.z,e=e.x),this.x=e,this.y=t,this.z=r}copy(){return new k(this.x,this.y,this.z)}copyTo(e){e.x=this.x,e.y=this.y,e.z=this.z}add(e){return new k(this.x+e.x,this.y+e.y,this.z+e.z)}sub(e){return new k(this.x-e.x,this.y-e.y,this.z-e.z)}length(){return this.lengthSquared()**.5}lengthSquared(){return this.x**2+this.y**2+this.z**2}distance(e){return this.distanceSquared(e)**.5}distanceSquared(e){return(this.x-e.x)**2+(this.y-e.y)**2+(this.z-e.z)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new k(0,e,0)}scale(e){return new k(this.x*e,this.y*e,this.z*e)}cross(e){var{x:t,y:r,z:n}=this;return new k(r*e.z-n*e.y,n*e.x-t*e.z,t*e.y-r*e.x)}rotate(e,t,r){return this.rotateX(e).rotateY(t).rotateZ(r)}rotateX(e=0){var t=this.x,r=this.y*z(e)-this.z*n(e);return e=this.y*n(e)+this.z*z(e),new k(t,r,e)}rotateY(e=0){var t=this.x*z(e)+this.z*n(e),r=this.y;return e=-this.x*n(e)+this.z*z(e),new k(t,r,e)}rotateZ(e=0){var t=this.x*z(e)-this.y*n(e);return e=this.x*n(e)+this.y*z(e),new k(t,e,this.z)}toAngles(e){let{x:t,y:r,z:n}=this;e&&(t=e.x-t,r=e.y-r,n=e.z-n),e=ee(r,t);var o=ee(-n,te(t*t+r*r)),a=0;return 0===t&&0===r||(a=te(t*t+r*r),a=ee(n,a)),{roll:a,pitch:o,yaw:e}}toWAngles(e){var{roll:e,pitch:t,yaw:r}=this.toAngles(e);return{rx:180/w*e,ry:180/w*t,rz:180/w*r}}}const S=Math["PI"],re=2*S,ne=t=>new Promise(e=>setTimeout(e,t));let E,M=0;const oe=new class{constructor(e){this.seed=e}rand(e=1,t=0){return this.seed^=this.seed<<13,this.seed^=this.seed>>>17,this.seed^=this.seed<<5,t+(e-t)*Math.abs(this.seed%1e9)/1e9}int(e,t=0){return Math.floor(this.rand(e,t))}sign(){return 2*this.randInt(2)-1}}(1234),B=(e=15e3)=>oe.rand(-e,e),ae={x:0,y:0,z:7500,rx:-90,ry:0,rz:0,vel:{x:0,y:0,z:0},thrust:{x:0,y:0,z:0},thrustForce:.08,fireCooldown:0,r:2,passType:"ship",passthru:["plasma"],shieldOpacity:0,sight:1500,aggro:0,thrustCooldown:0,hp:6,maxHp:5,facing:{x:0,y:1,z:0},inv:{parts:0},steerPercent:.05,explodes:{colors:["464040","5796a1"],size:1,count:20}},ie={...structuredClone(ae),thrustForce:.008,hp:5,passType:"klaxShip",passthru:["klaxPlasma"],facing:{x:1,y:0,z:0},drops:["parts"],explodes:{colors:["464040","702782"],size:5,count:30}},se=[],le=[ae],P={},de={},ce={volume:.3,sampleRate:44100,x:new AudioContext,play:function(...e){return this.playSamples(this.buildSamples(...e))},playSamples:function(...e){const r=this.x.createBuffer(e.length,e[0].length,this.sampleRate),t=this.x.createBufferSource();return e.map((e,t)=>r.getChannelData(t).set(e)),t.buffer=r,t.connect(this.x.destination),t.start(),t},buildSamples:function(e=1,t=.05,r=220,n=0,o=0,a=.1,i=0,s=1,l=0,d=0,c=0,p=0,h=0,g=0,m=0,u=0,y=0,f=1,x=0,v=0){var b=2*Math.PI,z=this.sampleRate,w=l*=500*b/z/z;t=r*=(1+2*t*Math.random()-t)*b/z;let k=[],S=0,E=0,M=0,B=1,P=0,C=0,L=0,_;for(d*=500*b/z**3,m*=b/z,c*=b/z,p*=z,h=h*z|0,_=(n=n*z+9)+(x*=z)+(o*=z)+(a*=z)+(y*=z)|0;M<_;k[M++]=L)++C%(100*u|0)||(L=i?1<i?2<i?3<i?Math.sin((S%b)**3):Math.max(Math.min(Math.tan(S),1),-1):1-(2*S/b%2+2)%2:1-4*Math.abs(Math.round(S/b)-S/b):Math.sin(S),L=(h?1-v+v*Math.sin(b*M/h):1)*(0<L?1:-1)*Math.abs(L)**s*e*this.volume*(M<n?M/n:M<n+x?1-(M-n)/x*(1-f):M<n+x+o?f:M<_-y?(_-M-y)/a*f:0),L=y?L/2+(y>M?0:(M<_-y?1:(_-M)/y)*k[M-y|0]/2):L),z=(r+=l+=d)*Math.cos(m*E++),S+=z-z*g*(1-1e9*(Math.sin(M)+1)%2),B&&++B>p&&(r+=c,t+=c,B=0),!h||++P%h||(r=t,l=w,B=B||1);return k},getNote:function(e=0,t=440){return t*2**(e/12)}},{min:pe,max:C,round:he,abs:ge}=Math,L={W:x,input:v,paused:0,nextEnter:0,ogKlaxShipCount:0};let _,T={};const F=1e3/60,A={back:-1.5,up:.6,rx:80,ry:0,rz:0,zoom:1},I={fov:30,targetFov:30,lastFov:31,aspect:1,near:.5,far:3e4},D={rx:-90,ry:0,rz:0},R="Check steering: [Tab] to toggle mouse-lock;Scan: Hold [C];Thrusters: [W] and [S];Fire weapons: [Space] or [Click];Boost: Hold [Shift];Klaxonian Ships Destroyed: {K} / {S};Ring Repair Parts: {P} / {M}".split(";").map(e=>({t:e,done:0})),me={plasma:{vScale:45,tScale:.004,damage:1,size:2,sound:[,.1,295,.02,.01,.08,,1.72,-3.5,.2,,,,.2,,,.08,.62,.09]},photon:{vScale:25,tScale:.0012,damage:3,size:2,sound:[2.06,.35,212,.05,.08,.01,,1.66,-4.8,.2,50,,,1.7,,.5,.28,.65,.02]},klaxPlasma:{vScale:45,tScale:.002,damage:1,size:10,sound:[.3,.4,241,.04,.03,.08,,.46,-7.7,,,,,,,.2,,.53,.05,.2]}};addEventListener("DOMContentLoaded",async()=>{e(),await ne(30),r(),await ne(30),L.paused=1,x.camera({x:0,y:0,z:0,rx:-13}),b.getElementById("hi").style.display="flex",L.nextEnter=()=>(b.getElementById("hi").style.display="none",q("<p>A Star-Hopper ship! You heard our distress call? ðŸ“¡ We're under attack by a Klaxonian fleet!</p><p>The entire sector is dependent on the POWER generated by our Bunson Ring. âš¡Please rescue us and help get the Ring operational again.</p>")),setInterval(r,F)}),window.g=L}();